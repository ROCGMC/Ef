<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ ¡åœ’å‹•æ…‹èª²è¡¨ç³»çµ±</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #2c3e50; --accent: #f1c40f; --bg: #f4f7f6; --card: #ffffff; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; overflow-x: hidden; }
        
        /* å³ä¸Šè§’é¸å–®æŒ‰éˆ• */
        .menu-btn { position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.1); border: none; color: white; font-size: 24px; cursor: pointer; z-index: 100; padding: 5px 10px; border-radius: 8px; }

        /* å„€è¡¨æ¿ */
        .dashboard { background: var(--primary); color: white; padding: 30px 15px; border-radius: 20px; text-align: center; margin-bottom: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); position: relative; }
        #status-text { font-size: 1.1rem; opacity: 0.9; margin-bottom: 5px; }
        #countdown { font-size: 4.5rem; font-weight: bold; color: var(--accent); margin: 5px 0; font-family: 'Courier New', monospace; }
        .school-time { font-size: 0.8rem; color: #95a5a6; }

        /* æ ¡å°æ§åˆ¶ */
        .cal-box { display: flex; justify-content: center; gap: 10px; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; }
        .btn-s { background: #455a64; border: none; color: white; padding: 5px 12px; border-radius: 5px; font-size: 12px; }

        /* é¸å–®èˆ‡å½ˆçª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; animation: fadeIn 0.3s; }
        .modal-content { background: #2c3e50; color: white; border-radius: 20px; padding: 25px; max-width: 450px; margin: 40px auto; position: relative; width: 85%; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; }
        
        /* åŠŸèƒ½åˆ— */
        .setting-item { display: flex; justify-content: space-between; align-items: center; margin: 20px 0; padding-bottom: 10px; border-bottom: 1px solid #3e4f5f; }
        .search-input { width: 100%; padding: 12px; border-radius: 8px; border: none; margin: 15px 0; font-size: 16px; }
        .teacher-result { background: #34495e; padding: 15px; border-radius: 12px; margin-top: 15px; border-left: 5px solid var(--accent); }

        /* èª²è¡¨è¡¨æ ¼ */
        .table-card { background: var(--card); border-radius: 15px; overflow-x: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th, td { padding: 12px 5px; text-align: center; border-bottom: 1px solid #f0f0f0; }
        th { background: #34495e; color: white; font-weight: normal; font-size: 14px; }
        .active-cell { background-color: var(--accent) !important; color: #000 !important; font-weight: bold; border-radius: 6px; }
        .teacher-name { font-size: 10px; color: #7f8c8d; display: block; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <button class="menu-btn" onclick="openModal('menuModal')">â˜°</button>

    <div class="dashboard">
        <div id="status-text">ç³»çµ±è®€å–ä¸­...</div>
        <div id="countdown">00:00</div>
        <div class="school-time">æ ¡æº–æ™‚é–“ï¼š<span id="real-clock">00:00:00</span></div>
        <div class="cal-box">
            <button class="btn-s" onclick="adj(-1)">-1s</button>
            <span id="offset-lab" style="font-size:12px; align-self:center;">æ ¡å°: 0s</span>
            <button class="btn-s" onclick="adj(1)">+1s</button>
        </div>
    </div>

    <div style="text-align:center; margin-bottom:15px;">
        <select id="classPicker" onchange="changeClass()" style="width:90%; padding:10px; border-radius:8px; border:1px solid #ddd;"></select>
    </div>

    <div class="table-card" id="tableBox"></div>

    <div id="menuModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('menuModal')">Ã—</span>
            <h3>åŠŸèƒ½è¨­å®š</h3>
            <div class="setting-item">
                <span>ğŸ”… è¢å¹•é•·äº®ä¸é—œé–‰</span>
                <input type="checkbox" id="wakeLockCheck" onchange="toggleWakeLock(this.checked)" style="width:20px; height:20px;">
            </div>
            <button onclick="openSearch()" style="width:100%; padding:15px; background:var(--accent); color:#000; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">ğŸ” æœå°‹æ•™å¸«å‹•æ…‹</button>
        </div>
    </div>

    <div id="searchModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('searchModal')">Ã—</span>
            <h3>æ•™å¸«ä½ç½®æœå°‹</h3>
            <input type="text" id="teacherInp" class="search-input" placeholder="è«‹è¼¸å…¥è€å¸«å…¨å..." oninput="doSearch()">
            <div id="searchRes"></div>
        </div>
    </div>

<script src="data.js"></script>
<script>
    // --- åˆå§‹åŒ– ---
    let offset = parseInt(localStorage.getItem('offset')) || 0;
    let wakeLock = null;

    function init() {
        if (typeof allSchedules === 'undefined') {
            document.getElementById('tableBox').innerHTML = "<p style='text-align:center;padding:20px;'>æ‰¾ä¸åˆ° data.js</p>";
            return;
        }
        const p = document.getElementById('classPicker');
        Object.keys(allSchedules).forEach(k => {
            let o = document.createElement('option'); o.value = k; o.text = k; p.appendChild(o);
        });
        p.value = localStorage.getItem('lastClass') || "é›»ä¸€ä¹™";
        
        render();
        setInterval(tick, 1000);
    }

    // --- æ ¸å¿ƒé‚è¼¯ ---
    function adj(v) { offset += v; localStorage.setItem('offset', offset); }
    function changeClass() { localStorage.setItem('lastClass', document.getElementById('classPicker').value); render(); }

    function render() {
        const cls = document.getElementById('classPicker').value;
        const d = allSchedules[cls];
        let h = `<table><tr><th>ç¯€</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th></tr>`;
        d.forEach((r, i) => {
            if (i === 4) h += `<tr style="background:#f9f9f9; font-size:12px; color:#999;"><td colspan="6">åˆä¼‘æ™‚é–“</td></tr>`;
            h += `<tr><td style="font-size:12px; color:#999;">${i+1}</td>`;
            r.forEach(c => {
                let [s, t] = c.split('(');
                h += `<td><b>${s}</b>${t ? `<span class="teacher-name">${t.replace(')','')}</span>` : ""}</td>`;
            });
            h += `</tr>`;
        });
        document.getElementById('tableBox').innerHTML = h + `</table>`;
    }

    function tick() {
        const now = new Date(Date.now() + offset * 1000);
        const sec = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
        const day = now.getDay();
        document.getElementById('real-clock').innerText = now.toTimeString().split(' ')[0];
        document.getElementById('offset-lab').innerText = `æ ¡å°: ${offset}s`;

        let cur = -1, cd = "--:--", st = "ğŸ  æ”¾å­¸/ä¼‘æ¯æ™‚é–“";

        timeSlots.forEach((o, i) => {
            const start = toS(o.start), end = toS(o.end);
            if (sec >= start && sec < end) {
                cur = i; st = `ğŸ”” æ­£åœ¨ä¸Šï¼š${o.name}`;
                let r = end - sec; cd = `${Math.floor(r/60)}:${String(r%60).padStart(2,'0')}`;
            } else if (sec < start && cd === "--:--") {
                let w = start - sec; st = `â˜• ä¸‹èª²ä¸­ï¼Œå¾…æœƒï¼š${o.name}`;
                cd = `${Math.floor(w/60)}:${String(w%60).padStart(2,'0')}`;
            }
        });

        document.getElementById('status-text').innerText = st;
        document.getElementById('countdown').innerText = cd;

        // é«˜äº®
        document.querySelectorAll('td').forEach(c => c.classList.remove('active-cell'));
        if (cur !== -1 && day >= 1 && day <= 5) {
            const rows = document.querySelectorAll('tr');
            const targetRow = rows[cur + (cur >= 4 ? 2 : 1)];
            if(targetRow) targetRow.cells[day].classList.add('active-cell');
        }
    }

    function toS(t) { const [h, m] = t.split(':'); return h * 3600 + m * 60; }

    // --- åŠŸèƒ½å½ˆçª— ---
    function openModal(id) { document.getElementById(id).style.display = 'block'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function openSearch() { closeModal('menuModal'); openModal('searchModal'); }

    // --- è¢å¹•é•·äº® (Wake Lock) ---
    async function toggleWakeLock(on) {
        if (on) {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log("Wake Lock Active");
            } catch (err) {
                alert("æ­¤è¨­å‚™ä¸æ”¯æ´è¢å¹•é•·äº®");
                document.getElementById('wakeLockCheck').checked = false;
            }
        } else if (wakeLock) {
            wakeLock.release();
            wakeLock = null;
        }
    }

    // --- æ•™å¸«æœå°‹ ---
    function doSearch() {
        const q = document.getElementById('teacherInp').value;
        const res = document.getElementById('searchRes');
        if (!q) { res.innerHTML = ""; return; }

        let found = [];
        Object.keys(allSchedules).forEach(cls => {
            allSchedules[cls].forEach((row, pi) => {
                row.forEach((cell, di) => {
                    if (cell.includes(q)) found.push({ cls, pi, di: di + 1 });
                });
            });
        });

        if (found.length === 0) { res.innerHTML = "æ‰¾ä¸åˆ°è³‡æ–™"; return; }

        const now = new Date(Date.now() + offset * 1000);
        const d = now.getDay();
        const s = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();

        let curPos = found.find(f => f.di === d && s >= toS(timeSlots[f.pi].start) && s < toS(timeSlots[f.pi].end));
        let nextPos = found.filter(f => f.di === d && toS(timeSlots[f.pi].start) > s).sort((a,b) => a.pi - b.pi)[0];

        res.innerHTML = `
            <div class="teacher-result">
                <h4>ğŸ‘¨â€ğŸ« ${q} è€å¸«</h4>
                <p>ğŸ“ ç›®å‰ï¼š${curPos ? `<b style="color:var(--accent)">${curPos.cls}</b>` : "ç„¡èª² / è¾¦å…¬å®¤"}</p>
                <p>â­ï¸ ä¸‹ä¸€ç¯€ï¼š${nextPos ? `<b>${nextPos.cls}</b>` : "ä»Šæ—¥ç„¡å¾ŒçºŒèª²ç¨‹"}</p>
            </div>
        `;
    }

    window.onload = init;
</script>
</body>
</html>
