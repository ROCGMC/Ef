<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§å‹•æ…‹èª²è¡¨çµ‚ç«¯ V4</title>
    <link href="https://fonts.cdnfonts.com/css/digital-7-mono" rel="stylesheet">
    <style>
        :root { --primary: #2196F3; --accent: #00ff41; --bg: #000; --red: #ff3b30; --panel: #1a1a1a; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #eee; overflow-x: hidden; }
        
        /* å„€è¡¨æ¿å€åŸŸ */
        .dashboard { background: #000; padding: 30px 15px; border-radius: 25px; text-align: center; margin-bottom: 15px; border: 2px solid #333; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .digital { font-family: 'Digital-7 Mono', sans-serif; line-height: 1; }
        
        #countdown { font-size: 5.5rem; color: var(--accent); text-shadow: 0 0 15px rgba(0, 255, 65, 0.5); margin: 10px 0; }
        #real-time { font-size: 1.8rem; color: var(--red); text-shadow: 0 0 10px rgba(255, 59, 48, 0.5); }
        #full-date { font-size: 1.1rem; color: #888; margin-bottom: 5px; letter-spacing: 2px; }

        /* ä¸‰æ¢ç·šé¸å–® */
        .menu-btn { position: absolute; top: 25px; right: 25px; background: none; border: none; cursor: pointer; padding: 5px; }
        .menu-btn div { width: 28px; height: 3px; background: white; margin: 6px 0; transition: 0.3s; border-radius: 2px; }

        /* èª²è¡¨é¡¯ç¤º */
        .table-card { background: var(--panel); border-radius: 15px; overflow-x: auto; border: 1px solid #333; }
        table { width: 100%; border-collapse: collapse; min-width: 480px; }
        th, td { border: 1px solid #222; padding: 12px 5px; text-align: center; font-size: 14px; }
        th { background: #111; color: #666; font-weight: normal; }
        .active-cell { background-color: rgba(0, 255, 65, 0.15) !important; color: var(--accent); font-weight: bold; border: 1px solid var(--accent); }
        .teacher { font-size: 11px; color: #777; display: block; margin-top: 3px; }

        /* å½ˆçª—ç³»çµ± */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; overflow-y: auto; padding-top: 20px; }
        .modal-body { background: #111; margin: 0 auto 40px; padding: 25px; width: 85%; max-width: 500px; border-radius: 25px; border: 1px solid #333; }
        input, textarea, select { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: white; border-radius: 10px; margin: 10px 0; box-sizing: border-box; font-size: 16px; }
        
        /* è¡Œäº‹æ›† */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 15px; }
        .cal-day { padding: 10px 0; background: #222; border-radius: 8px; font-size: 13px; cursor: pointer; text-align: center; }
        .cal-day.holiday { color: var(--red); font-weight: bold; }
        .cal-day.note-mark { border-bottom: 3px solid var(--primary); }
        .cal-header { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; color: #555; font-size: 12px; margin-bottom: 5px; }

        button { width: 100%; padding: 14px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin: 10px 0; font-size: 16px; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-green { background: var(--accent); color: black; }
        .btn-dark { background: #333; color: white; }
    </style>
</head>
<body>

<div class="dashboard">
    <button class="menu-btn" onclick="toggleModal('menuModal')"><div></div><div></div><div></div></button>
    <div id="full-date" class="digital">2026 / 02 / 27</div>
    <div id="countdown" class="digital">00:00:00</div>
    <div id="real-time" class="digital">00:00:00</div>
</div>

<select id="classSelector" onchange="switchClass()"></select>

<div id="holiday-banner" style="display:none; text-align:center; padding:40px 20px; color:var(--accent); font-size:1.5rem; font-weight:bold;">
    ğŸï¸ åœ‹å®šå‡æ—¥ / é€±æœ«ä¼‘æ¯
</div>

<div class="table-card" id="tableBox"></div>

<div id="menuModal" class="modal">
    <div class="modal-body">
        <h2 style="color:var(--primary); margin-top:0;">SYSTEM MENU</h2>
        
        <label>â±ï¸ æ™‚é–“åç§»å¾®èª¿ (ç§’):</label>
        <input type="number" id="offsetInput" step="0.5" value="0" oninput="updateOffset(this.value)">
        
        <button class="btn-blue" onclick="toggleModal('calModal')">ğŸ“… é–‹å•Ÿæ ¡åœ’è¡Œäº‹æ›†</button>

        <hr style="border-color:#333; margin:20px 0;">
        
        <h4>ğŸ” æ•™å¸«è¿½è¹¤</h4>
        <input type="text" id="tSearch" placeholder="æœå°‹è€å¸«åå­—..." oninput="handleSearch()">
        <div id="searchInfo" style="background:#000; padding:15px; border-radius:10px; font-size:14px; color:var(--accent); line-height:1.6;"></div>

        <hr style="border-color:#333; margin:20px 0;">
        
        <h4>ğŸ› ï¸ æ ¸å¿ƒè³‡æ–™åº« (JSON)</h4>
        <textarea id="jsonDB" placeholder="è²¼ä¸Šèª²è¡¨ JSON..."></textarea>
        <button class="btn-green" onclick="saveDB()">å„²å­˜ä¸¦æ›´æ–°ç³»çµ±</button>
        <button class="btn-dark" onclick="toggleModal('menuModal')">é—œé–‰é¸å–®</button>
    </div>
</div>

<div id="calModal" class="modal">
    <div class="modal-body">
        <h3 id="calMonthTitle" style="text-align:center;">2026 / 02</h3>
        <div class="cal-header"><div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div></div>
        <div class="calendar-grid" id="calendarGrid"></div>
        
        <div id="notePanel" style="display:none; margin-top:20px; background:#000; padding:15px; border-radius:15px;">
            <div id="selDateDisplay" style="color:var(--primary); font-weight:bold; margin-bottom:10px;"></div>
            <textarea id="dateNote" style="height:80px;" placeholder="å¯«ä¸‹å‚™è¨»..."></textarea>
            <button class="btn-blue" onclick="saveDateNote()">å„²å­˜å‚™è¨»</button>
        </div>
        
        <button class="btn-dark" onclick="toggleModal('calModal')">è¿”å›</button>
    </div>
</div>

<script>
    // --- åˆå§‹è³‡æ–™èˆ‡é…ç½® ---
    const slots = [
        { s: "08:10", e: "09:00" }, { s: "09:10", e: "10:00" }, { s: "10:10", e: "11:00" },
        { s: "11:10", e: "12:00" }, { s: "13:10", e: "14:00" }, { s: "14:10", e: "15:00" }, { s: "15:20", e: "16:10" }
    ];

    // 2026 åœ‹å®šå‡æ—¥æ¸…å–®
    const holidays2026 = ["2026-01-01", "2026-01-28", "2026-01-29", "2026-01-30", "2026-02-17", "2026-02-28", "2026-04-04", "2026-04-05", "2026-05-01", "2026-06-19", "2026-10-10"];

    let db = JSON.parse(localStorage.getItem('edu_db')) || { "é›»ä¸€ä¹™": Array.from({length:7},()=>Array(5).fill("æœªè¨­å®š")) };
    let offset = parseFloat(localStorage.getItem('edu_offset')) || 0;
    let notes = JSON.parse(localStorage.getItem('edu_notes')) || {};
    let curClass = localStorage.getItem('edu_class') || Object.keys(db)[0];
    let focusedDate = "";

    function init() {
        renderClassList();
        renderTable();
        renderCalendar();
        document.getElementById('jsonDB').value = JSON.stringify(db, null, 2);
        document.getElementById('offsetInput').value = offset;
        setInterval(updateTick, 1000);
    }

    // --- æ ¸å¿ƒè¨ˆæ™‚é‚è¼¯ ---
    function updateTick() {
        const now = new Date();
        const adjusted = new Date(now.getTime() + offset * 1000);
        
        // æ›´æ–° UI æ™‚é–“
        document.getElementById('full-date').innerText = adjusted.toLocaleDateString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit'}).replace(/\//g,' / ');
        document.getElementById('real-time').innerText = adjusted.toTimeString().split(' ')[0];
        
        const secOfDay = adjusted.getHours() * 3600 + adjusted.getMinutes() * 60 + adjusted.getSeconds();
        const dayOfWeek = adjusted.getDay();
        const dateKey = adjusted.toISOString().split('T')[0];

        // å‡æ—¥åˆ¤å®š
        const isOff = (dayOfWeek === 0 || dayOfWeek === 6 || holidays2026.includes(dateKey));
        document.getElementById('holiday-banner').style.display = isOff ? "block" : "none";
        document.getElementById('tableBox').style.display = isOff ? "none" : "block";

        // å€’æ•¸è¨ˆæ™‚è¨ˆç®—
        let currentPeriod = -1, cdSeconds = 0;
        slots.forEach((slot, i) => {
            const start = timeToSec(slot.s), end = timeToSec(slot.e);
            if (secOfDay >= start && secOfDay < end) { currentPeriod = i; cdSeconds = end - secOfDay; }
            else if (secOfDay < start && cdSeconds === 0) { cdSeconds = start - secOfDay; }
        });

        document.getElementById('countdown').innerText = formatHMS(cdSeconds);
        
        // è¢å¹•è¡¨æ ¼äº®é»
        document.querySelectorAll('td').forEach(c => c.classList.remove('active-cell'));
        if (currentPeriod !== -1 && dayOfWeek >= 1 && dayOfWeek <= 5 && !isOff) {
            const rowIdx = currentPeriod + (currentPeriod >= 4 ? 2 : 1);
            const row = document.querySelectorAll('tr')[rowIdx];
            if (row) row.cells[dayOfWeek].classList.add('active-cell');
        }
    }

    function formatHMS(s) {
        const h = Math.floor(s / 3600);
        const m = Math.floor((s % 3600) / 60);
        const sec = s % 60;
        let res = h > 0 ? `${h}:` : "";
        return res + `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    }

    // --- è¡Œäº‹æ›†èˆ‡å‚™è¨» ---
    function renderCalendar() {
        const d = new Date();
        const y = d.getFullYear(), m = d.getMonth();
        document.getElementById('calMonthTitle').innerText = `${y} / ${String(m+1).padStart(2,'0')}`;
        
        const firstDay = new Date(y, m, 1).getDay();
        const totalDays = new Date(y, m + 1, 0).getDate();
        
        let html = "";
        for(let i=0; i<firstDay; i++) html += `<div></div>`;
        for(let day=1; day<=totalDays; day++) {
            const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            const isH = holidays2026.includes(dateStr);
            const hasN = notes[dateStr] ? "note-mark" : "";
            html += `<div class="cal-day ${isH?'holiday':''} ${hasN}" onclick="openNote('${dateStr}')">${day}</div>`;
        }
        document.getElementById('calendarGrid').innerHTML = html;
    }

    function openNote(date) {
        focusedDate = date;
        document.getElementById('notePanel').style.display = "block";
        document.getElementById('selDateDisplay').innerText = "æ—¥æœŸ: " + date;
        document.getElementById('dateNote').value = notes[date] || "";
    }

    function saveDateNote() {
        notes[focusedDate] = document.getElementById('dateNote').value;
        localStorage.setItem('edu_notes', JSON.stringify(notes));
        renderCalendar();
        alert("å‚™è¨»å·²æ›´æ–°");
    }

    // --- æ•™å¸«æœå°‹ ---
    function handleSearch() {
        const q = document.getElementById('tSearch').value.trim();
        const res = document.getElementById('searchInfo');
        if(!q) return res.innerHTML = "";
        
        const now = new Date(Date.now() + offset * 1000);
        const day = now.getDay();
        const sec = now.getHours() * 3600 + now.getMinutes() * 60;
        
        let curP = -1, nxtP = -1;
        slots.forEach((s, i) => {
            if(sec >= timeToSec(s.s) && sec < timeToSec(s.e)) curP = i;
            if(sec < timeToSec(s.s) && nxtP === -1) nxtP = i;
        });

        let currentLoc = "ä¸åœ¨æ•™å®¤", nextLoc = "ç„¡èª²ç¨‹";
        Object.keys(db).forEach(cls => {
            if(curP!==-1 && db[cls][curP][day-1]?.includes(q)) currentLoc = `æ­£åœ¨ ${cls}`;
            if(nxtP!==-1 && db[cls][nxtP][day-1]?.includes(q)) nextLoc = cls;
        });
        res.innerHTML = `ğŸ“ ç›®å‰ï¼š${currentLoc}<br>â­ï¸ ä¸‹ä¸€ç¯€ï¼š${nextLoc}`;
    }

    // --- ç³»çµ±åŠŸèƒ½ ---
    function updateOffset(v) { offset = parseFloat(v) || 0; localStorage.setItem('edu_offset', offset); }
    function saveDB() {
        try {
            db = JSON.parse(document.getElementById('jsonDB').value);
            localStorage.setItem('full_database', JSON.stringify(db));
            renderClassList(); renderTable(); alert("è³‡æ–™åº«å·²å„²å­˜");
        } catch(e) { alert("JSON æ ¼å¼éŒ¯èª¤ï¼"); }
    }
    function renderClassList() {
        document.getElementById('classSelector').innerHTML = Object.keys(db).map(c => `<option value="${c}" ${c===curClass?'selected':''}>${c}</option>`).join('');
    }
    function renderTable() {
        const data = db[curClass] || db[Object.keys(db)[0]];
        let h = `<table><tr><th>ç¯€</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th></tr>`;
        data.forEach((row, i) => {
            if(i===4) h += `<tr style="background:#111;color:#444;font-size:12px;"><td colspan="6">åˆä¼‘ LUNCH BREAK</td></tr>`;
            h += `<tr><td>${i+1}</td>` + row.map(c => {
                let [s, t] = c.split('(');
                return `<td>${s}${t ? `<span class="teacher">(${t}</span>` : ""}</td>`;
            }).join('') + `</tr>`;
        });
        document.getElementById('tableBox').innerHTML = h + `</table>`;
    }
    function switchClass() { curClass = document.getElementById('classSelector').value; localStorage.setItem('edu_class', curClass); renderTable(); }
    function timeToSec(t) { const [h, m] = t.split(':'); return h * 3600 + m * 60; }
    function toggleModal(id) { const m = document.getElementById(id); m.style.display = (m.style.display==='block'?'none':'block'); }
    window.onload = init;
</script>
</body>
</html>
