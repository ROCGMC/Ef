<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>課表系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .is-now { border: 3px solid #3b82f6; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        .blink { animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20">

    <div class="max-w-md mx-auto p-4">
        <div class="bg-white rounded-3xl p-6 shadow-sm mb-6">
            <div class="flex justify-between items-center mb-4">
                <span id="date-display" class="text-sm font-bold text-slate-400">正在讀取...</span>
                <span id="clock" class="text-lg font-mono font-bold text-slate-800">00:00:00</span>
            </div>

            <div class="mb-4 text-center py-2 rounded-2xl bg-slate-50">
                <p id="status-label" class="text-xs font-black uppercase tracking-widest text-slate-400">狀態</p>
                <div id="countdown-timer" class="text-4xl font-black font-mono my-1">--:--</div>
            </div>

            <div id="now-card" class="mb-4">
                <p class="text-xs font-black text-blue-500 uppercase tracking-widest">Current 當前課程</p>
                <h1 id="current-lesson" class="text-2xl font-bold text-slate-800">目前沒課</h1>
                <div class="flex gap-2 items-center">
                    <p id="current-teacher" class="text-slate-500">--</p>
                    <span id="current-location" class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-bold hidden">地點</span>
                </div>
            </div>
            
            <div class="border-t border-slate-100 pt-4">
                <p class="text-xs font-black text-slate-400 uppercase tracking-widest">Next 下一節</p>
                <h2 id="next-lesson" class="text-lg font-bold text-slate-700">--</h2>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-8">
            <button onclick="openSetup()" class="bg-slate-800 text-white py-4 rounded-2xl font-bold shadow-lg">設定每週課表</button>
            <button onclick="openModal('rescheduleModal')" class="bg-amber-500 text-white py-4 rounded-2xl font-bold shadow-lg">今日調課</button>
        </div>

        <h3 class="font-bold text-slate-800 mb-4 px-1">今日課程清單</h3>
        <div id="schedule-list" class="space-y-3"></div>
    </div>

    <div id="setupModal" class="fixed inset-0 bg-black/60 hidden z-50 p-4 flex items-center justify-center">
        <div class="bg-white rounded-3xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4">設定週循環課表</h2>
            <select id="edit-day-select" onchange="renderSetupInputs(this.value)" class="w-full p-3 border rounded-xl mb-4 bg-blue-50 font-bold text-blue-600 border-blue-200">
                <option value="1">編輯：週一</option><option value="2">編輯：週二</option>
                <option value="3">編輯：週三</option><option value="4">編輯：週四</option>
                <option value="5">編輯：週五</option>
            </select>
            <div id="setup-inputs" class="space-y-4"></div>
            <button onclick="saveBaseSchedule()" class="w-full bg-blue-600 text-white py-4 rounded-xl mt-6 font-bold shadow-lg">儲存此日課表</button>
            <button onclick="closeModal('setupModal')" class="w-full text-slate-400 py-2 mt-2">關閉</button>
        </div>
    </div>

    <div id="rescheduleModal" class="fixed inset-0 bg-black/60 hidden z-50 p-4 flex items-center justify-center">
        <div class="bg-white rounded-3xl w-full max-w-md p-6">
            <h2 class="text-xl font-bold mb-4">今日臨時調課</h2>
            <select id="resched-slot" class="w-full p-3 border rounded-xl mb-4 bg-slate-50"></select>
            <input id="resched-name" type="text" placeholder="新的課程名稱" class="w-full p-3 border rounded-xl mb-3">
            <input id="resched-teacher" type="text" placeholder="新的老師名稱" class="w-full p-3 border rounded-xl mb-3">
            <input id="resched-loc" type="text" placeholder="新的地點" class="w-full p-3 border rounded-xl mb-4">
            <button onclick="saveReschedule()" class="w-full bg-amber-500 text-white py-3 rounded-xl font-bold">確認變更</button>
            <button onclick="closeModal('rescheduleModal')" class="w-full text-slate-400 py-2 mt-2">取消</button>
        </div>
    </div>

    <script>
        const timeSlots = [
            { id: 1, start: "08:10", end: "09:00" },
            { id: 2, start: "09:10", end: "10:00" },
            { id: 3, start: "10:10", end: "11:00" },
            { id: 4, start: "11:10", end: "12:00" },
            { id: 5, start: "13:10", end: "14:00" },
            { id: 6, start: "14:10", end: "15:00" },
            { id: 7, start: "15:20", end: "16:10" },
            { id: 8, start: "16:20", end: "17:10" }
        ];

        let baseSchedule = JSON.parse(localStorage.getItem('baseSchedule')) || {};
        let reschedules = JSON.parse(localStorage.getItem('reschedules')) || {};

        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toTimeString().split(' ')[0];
            const days = ["週日", "週一", "週二", "週三", "週四", "週五", "週六"];
            document.getElementById('date-display').innerText = `${now.getMonth()+1}/${now.getDate()} ${days[now.getDay()]}`;
            handleTimers(now);
            refreshUI(now);
        }

        function handleTimers(now) {
            const currentTime = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
            const timerEl = document.getElementById('countdown-timer');
            const labelEl = document.getElementById('status-label');
            let found = false;

            // 1. 上課中 (紅色)
            for (let slot of timeSlots) {
                const start = parseTime(slot.start);
                const end = parseTime(slot.end);
                if (currentTime >= start && currentTime < end) {
                    const remain = end - currentTime;
                    labelEl.innerText = "上課中 - 距離下課";
                    labelEl.className = "text-xs font-black uppercase text-red-500";
                    timerEl.innerText = formatDuration(remain);
                    timerEl.className = "text-4xl font-black font-mono my-1 text-red-500";
                    found = true; break;
                }
            }

            // 2. 打掃時間 (12:00 - 12:30) (黃色/琥珀色)
            const cleanStart = 12 * 3600;
            const cleanEnd = 12 * 3600 + 30 * 60;
            if (!found && currentTime >= cleanStart && currentTime < cleanEnd) {
                const remain = cleanEnd - currentTime;
                labelEl.innerText = "午餐與打掃時間";
                labelEl.className = "text-xs font-black uppercase text-amber-500";
                timerEl.innerText = formatDuration(remain);
                timerEl.className = "text-4xl font-black font-mono my-1 text-amber-500";
                found = true;
            }

            // 3. 午休時間 (12:30 - 13:10) (藍色)
            const sleepEnd = 13 * 3600 + 10 * 60;
            if (!found && currentTime >= cleanEnd && currentTime < sleepEnd) {
                const remain = sleepEnd - currentTime;
                labelEl.innerText = "午休時間";
                labelEl.className = "text-xs font-black uppercase text-blue-500";
                timerEl.innerText = formatDuration(remain);
                timerEl.className = "text-4xl font-black font-mono my-1 text-blue-500";
                found = true;
            }

            // 4. 下課休息中 (綠色，前3分變紅)
            if (!found) {
                for (let slot of timeSlots) {
                    const start = parseTime(slot.start);
                    if (currentTime < start) {
                        const remain = start - currentTime;
                        const isPreClass = remain <= 180;
                        labelEl.innerText = isPreClass ? "⚠️ 準備上課 - 倒計時" : "下課休息中 - 距離上課";
                        timerEl.innerText = formatDuration(remain);
                        timerEl.className = `text-4xl font-black font-mono my-1 ${isPreClass ? 'text-red-500 blink' : 'text-green-500'}`;
                        labelEl.className = `text-xs font-black uppercase ${isPreClass ? 'text-red-500 blink' : 'text-green-500'}`;
                        found = true; break;
                    }
                }
            }

            if (!found) { labelEl.innerText = "放學時間"; timerEl.innerText = "--:--"; timerEl.className = "text-4xl font-black font-mono my-1 text-slate-300"; }
        }

        // 其他輔助函數維持不變...
        function parseTime(str) { const [h, m] = str.split(':').map(Number); return h * 3600 + m * 60; }
        function formatDuration(sec) { return `${Math.floor(sec / 60).toString().padStart(2, '0')}:${(sec % 60).toString().padStart(2, '0')}`; }

        function refreshUI(now) {
            const day = now.getDay(); const currentTimeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            const todayStr = now.toISOString().split('T')[0];
            let currentLesson = null; let nextLesson = null; let listHTML = '';
            if (day === 0 || day === 6) { document.getElementById('schedule-list').innerHTML = '<div class="text-center py-10 text-slate-400">週末愉快！</div>'; return; }
            timeSlots.forEach(slot => {
                let lesson = baseSchedule[`${day}-${slot.id}`] || { name: "", teacher: "", loc: "" };
                if (reschedules[todayStr] && reschedules[todayStr][slot.id]) lesson = reschedules[todayStr][slot.id];
                const isNow = currentTimeStr >= slot.start && currentTimeStr < slot.end;
                if (isNow) currentLesson = lesson;
                if (currentTimeStr < slot.start && !nextLesson && lesson.name) nextLesson = lesson;
                listHTML += `<div class="p-4 rounded-2xl bg-white shadow-sm flex items-center gap-4 ${isNow ? 'is-now' : ''}">
                    <div class="text-center min-w-[60px]"><div class="text-xs text-slate-400">${slot.start}</div><div class="font-bold text-slate-700">第 ${slot.id} 節</div></div>
                    <div class="flex-1"><div class="font-bold text-slate-800">${lesson.name || '空堂'}</div><div class="flex gap-2 items-center"><div class="text-sm text-slate-400">${lesson.teacher || '--'}</div>${lesson.loc ? `<div class="text-[10px] bg-slate-100 text-slate-500 px-1.5 rounded border border-slate-200">${lesson.loc}</div>` : ''}</div></div>
                </div>`;
            });
            document.getElementById('schedule-list').innerHTML = listHTML;
            document.getElementById('current-lesson').innerText = currentLesson?.name || "目前沒課";
            document.getElementById('current-teacher').innerText = currentLesson?.teacher || "--";
            const locEl = document.getElementById('current-location');
            if (currentLesson?.loc) { locEl.innerText = currentLesson.loc; locEl.classList.remove('hidden'); } else { locEl.classList.add('hidden'); }
            document.getElementById('next-lesson').innerText = nextLesson?.name || "無下節課";
        }

        function openSetup() { let currentDay = new Date().getDay(); if (currentDay === 0 || currentDay === 6) currentDay = 1; document.getElementById('edit-day-select').value = currentDay; renderSetupInputs(currentDay); openModal('setupModal'); }
        function renderSetupInputs(day) {
            let html = '';
            timeSlots.forEach(slot => {
                const data = baseSchedule[`${day}-${slot.id}`] || { name: "", teacher: "", loc: "" };
                html += `<div class="p-3 bg-slate-50 rounded-xl space-y-2">
                    <div class="text-xs font-bold text-blue-500">第 ${slot.id} 節</div>
                    <div class="grid grid-cols-2 gap-2"><input id="input-n-${slot.id}" type="text" value="${data.name}" placeholder="課程" class="p-2 border rounded-lg text-sm outline-none"><input id="input-t-${slot.id}" type="text" value="${data.teacher}" placeholder="老師" class="p-2 border rounded-lg text-sm outline-none"></div>
                    <input id="input-l-${slot.id}" type="text" value="${data.loc || ''}" placeholder="上課地點" class="w-full p-2 border rounded-lg text-sm outline-none">
                </div>`;
            });
            document.getElementById('setup-inputs').innerHTML = html;
        }
        function saveBaseSchedule() {
            const day = document.getElementById('edit-day-select').value;
            timeSlots.forEach(slot => { baseSchedule[`${day}-${slot.id}`] = { name: document.getElementById(`input-n-${slot.id}`).value, teacher: document.getElementById(`input-t-${slot.id}`).value, loc: document.getElementById(`input-l-${slot.id}`).value }; });
            localStorage.setItem('baseSchedule', JSON.stringify(baseSchedule)); alert('儲存成功！'); refreshUI(new Date());
        }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); if(id === 'rescheduleModal') { let options = ''; timeSlots.forEach(s => options += `<option value="${s.id}">第 ${s.id} 節</option>`); document.getElementById('resched-slot').innerHTML = options; } }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function saveReschedule() {
            const slotId = document.getElementById('resched-slot').value; const todayStr = new Date().toISOString().split('T')[0];
            if (!reschedules[todayStr]) reschedules[todayStr] = {};
            reschedules[todayStr][slotId] = { name: document.getElementById('resched-name').value, teacher: document.getElementById('resched-teacher').value, loc: document.getElementById('resched-loc').value };
            localStorage.setItem('reschedules', JSON.stringify(reschedules)); closeModal('rescheduleModal');
        }
        setInterval(updateClock, 1000); updateClock();
    </script>
</body>
</html>
