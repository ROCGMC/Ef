<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª²è¡¨ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .is-now { border: 3px solid #3b82f6; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        .blink { animation: blink 1s infinite; }
        .calendar-day.active { background-color: #3b82f6; color: white; border-radius: 99px; font-weight: bold; }
        .calendar-day.has-event::after { content: ''; display: block; width: 4px; height: 4px; background: #f59e0b; border-radius: 50%; margin: 0 auto; }
        .calendar-day.holiday { color: #ef4444; }
        .calendar-day.today { border: 1px solid #3b82f6; border-radius: 99px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-24">

    <div class="max-w-md mx-auto p-4">
        <div class="bg-white rounded-3xl p-6 shadow-sm mb-6 border-b-4 border-slate-200">
            <div class="flex justify-between items-center mb-4">
                <span id="date-display" class="text-sm font-bold text-slate-400">æ­£åœ¨è®€å–...</span>
                <div class="text-right flex items-center gap-2">
                    <span id="wake-status" class="text-slate-300">ğŸ’¡</span>
                    <span id="clock" class="text-lg font-mono font-bold text-slate-800">00:00:00</span>
                </div>
            </div>

            <div id="status-container" class="mb-4 text-center py-4 rounded-2xl bg-slate-50">
                <p id="status-label" class="text-xs font-black uppercase tracking-widest text-slate-400">ç‹€æ…‹</p>
                <div id="countdown-timer" class="text-4xl font-black font-mono my-1">--:--</div>
                <div id="today-note" class="text-xs font-bold text-amber-600 empty:hidden mt-1 px-4"></div>
            </div>

            <div id="now-card" class="mb-4 text-center">
                <p class="text-[10px] font-black text-blue-500 uppercase tracking-widest mb-1">Current ç•¶å‰èª²ç¨‹</p>
                <h1 id="current-lesson" class="text-2xl font-bold text-slate-800">ç›®å‰æ²’èª²</h1>
                <p id="current-teacher" class="text-sm text-slate-500 mt-1">--</p>
            </div>

            <div id="next-card" class="border-t border-slate-100 pt-4 flex justify-between items-center">
                <div>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Next ä¸‹ä¸€ç¯€</p>
                    <h2 id="next-lesson" class="font-bold text-slate-700">--</h2>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-3 mb-8">
            <button onclick="openSetup()" class="bg-slate-800 text-white py-3 rounded-2xl font-bold shadow-md text-xs active:scale-95 transition">è¨­å®šèª²è¡¨</button>
            <button onclick="openCalendar()" class="bg-blue-600 text-white py-3 rounded-2xl font-bold shadow-md text-xs active:scale-95 transition">è¡Œäº‹æ›†</button>
            <button onclick="openModal('rescheduleModal')" class="bg-amber-500 text-white py-3 rounded-2xl font-bold shadow-md text-xs active:scale-95 transition">ä»Šæ—¥èª¿èª²</button>
        </div>

        <div id="schedule-list" class="space-y-3"></div>
    </div>

    <div id="calendarModal" class="fixed inset-0 bg-black/60 hidden z-50 p-4 flex items-center justify-center">
        <div class="bg-white rounded-3xl w-full max-w-md p-6 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 id="calendar-month-year" class="text-lg font-bold"></h2>
                <div class="flex gap-1">
                    <button onclick="changeMonth(-1)" class="p-2 bg-slate-100 rounded-lg text-xs font-bold">ï¼œ</button>
                    <button onclick="changeMonth(1)" class="p-2 bg-slate-100 rounded-lg text-xs font-bold">ï¼</button>
                </div>
            </div>
            <div class="grid grid-cols-7 gap-1 text-center text-[10px] font-black text-slate-400 mb-2">
                <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
            </div>
            <div id="calendar-days" class="grid grid-cols-7 gap-1 text-center mb-4"></div>
            <div id="day-detail" class="bg-slate-50 rounded-2xl p-4 flex-1 overflow-y-auto">
                <p id="selected-date-text" class="text-xs font-black text-blue-600 mb-2 uppercase tracking-wider"></p>
                <textarea id="cal-note" rows="2" placeholder="è¼¸å…¥å‚™è¨» (è¼¸å…¥'æ”¾å‡'æˆ–'å‡æ—¥'ç•¶å¤©ä¸é¡¯ç¤ºèª²è¡¨)" class="w-full p-3 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-400 bg-white"></textarea>
                <button onclick="saveDayEvent()" class="w-full bg-blue-600 text-white py-3 rounded-xl text-sm font-bold mt-3">å„²å­˜å‚™è¨»</button>
            </div>
            <button onclick="closeModal('calendarModal')" class="w-full text-slate-400 py-3 mt-2 text-sm">é—œé–‰</button>
        </div>
    </div>

    <div id="setupModal" class="fixed inset-0 bg-black/60 hidden z-50 p-4 flex items-center justify-center">...</div>
    <div id="rescheduleModal" class="fixed inset-0 bg-black/60 hidden z-50 p-4 flex items-center justify-center">...</div>

    <script>
        // 2026 åœ‹å®šå‡æ—¥åº« (æ™ºæ…§åˆ¤å®š)
        const holidays2026 = {
            "2026-01-01": "å…ƒæ—¦",
            "2026-02-14": "æ˜¥ç¯€é€£å‡", "2026-02-15": "æ˜¥ç¯€é€£å‡", "2026-02-16": "é™¤å¤•", "2026-02-17": "åˆä¸€", "2026-02-18": "åˆäºŒ", "2026-02-19": "åˆä¸‰", "2026-02-20": "æ˜¥ç¯€è£œå‡", "2026-02-21": "æ˜¥ç¯€é€£å‡", "2026-02-22": "æ˜¥ç¯€é€£å‡",
            "2026-02-27": "228é€£å‡", "2026-02-28": "å’Œå¹³ç´€å¿µæ—¥", "2026-03-01": "228é€£å‡",
            "2026-04-03": "å…’ç«¥ç¯€è£œå‡", "2026-04-04": "å…’ç«¥ç¯€", "2026-04-05": "æ¸…æ˜ç¯€", "2026-04-06": "æ¸…æ˜ç¯€è£œå‡",
            "2026-05-01": "å‹å‹•ç¯€", "2026-06-19": "ç«¯åˆç¯€",
            "2026-09-25": "ä¸­ç§‹ç¯€", "2026-09-28": "æ•™å¸«ç¯€",
            "2026-10-09": "åœ‹æ…¶è£œå‡", "2026-10-10": "åœ‹æ…¶æ—¥",
            "2026-10-25": "å…‰å¾©ç¯€", "2026-10-26": "å…‰å¾©ç¯€è£œå‡",
            "2026-12-25": "è¡Œæ†²ç´€å¿µæ—¥"
        };

        const timeSlots = [
            { id: 1, start: "08:10", end: "09:00" }, { id: 2, start: "09:10", end: "10:00" },
            { id: 3, start: "10:10", end: "11:00" }, { id: 4, start: "11:10", end: "12:00" },
            { id: 5, start: "13:10", end: "14:00" }, { id: 6, start: "14:10", end: "15:00" },
            { id: 7, start: "15:20", end: "16:10" }, { id: 8, start: "16:20", end: "17:10" }
        ];

        let baseSchedule = JSON.parse(localStorage.getItem('baseSchedule')) || {};
        let reschedules = JSON.parse(localStorage.getItem('reschedules')) || {};
        let dayEvents = JSON.parse(localStorage.getItem('dayEvents')) || {};
        let timeOffset = parseInt(localStorage.getItem('timeOffset')) || 0;

        let calViewDate = new Date();
        let selectedDateStr = new Date().toISOString().split('T')[0];

        function isHoliday(dateStr) {
            const day = new Date(dateStr).getDay();
            const isWeekend = (day === 0 || day === 6);
            const isPublicHoliday = holidays2026[dateStr];
            const isManualHoliday = (dayEvents[dateStr] && (dayEvents[dateStr].includes("å‡") || dayEvents[dateStr].includes("ä¼‘")));
            return isPublicHoliday || isManualHoliday || (isWeekend && !dayEvents[dateStr]?.includes("è£œèª²"));
        }

        function updateClock() {
            const realNow = new Date();
            const adjustedNow = new Date(realNow.getTime() + timeOffset * 1000);
            const todayStr = adjustedNow.toISOString().split('T')[0];
            const holidayName = holidays2026[todayStr] || (isHoliday(todayStr) ? "ä¼‘å‡æ—¥" : null);
            
            document.getElementById('clock').innerText = adjustedNow.toTimeString().split(' ')[0];
            document.getElementById('date-display').innerText = `${adjustedNow.getMonth()+1}/${adjustedNow.getDate()} ${["é€±æ—¥","é€±ä¸€","é€±äºŒ","é€±ä¸‰","é€±å››","é€±äº”","é€±å…­"][adjustedNow.getDay()]}`;
            
            const noteText = dayEvents[todayStr] || "";
            document.getElementById('today-note').innerText = holidayName ? `ğŸ—“ï¸ ${holidayName}${noteText ? 'ï¼š'+noteText : ''}` : noteText;

            if (holidayName) {
                // æ”¾å‡æ¨¡å¼ UI
                document.getElementById('status-label').innerText = "ä»Šå¤©æ˜¯";
                document.getElementById('status-label').className = "text-xs font-black text-green-500 uppercase";
                document.getElementById('countdown-timer').innerText = "æ”¾å‡ ğŸ¥³";
                document.getElementById('countdown-timer').className = "text-4xl font-black text-green-500 my-1";
                document.getElementById('now-card').classList.add('hidden');
                document.getElementById('next-card').classList.add('hidden');
                document.getElementById('schedule-list').innerHTML = `<div class="text-center py-20 text-slate-300 font-bold">åœ‹å®šå‡æ—¥æˆ–é€±æœ«ï¼Œå¥½å¥½ä¼‘æ¯å§ï¼</div>`;
            } else {
                // ä¸Šèª²æ¨¡å¼ UI
                document.getElementById('now-card').classList.remove('hidden');
                document.getElementById('next-card').classList.remove('hidden');
                handleTimers(adjustedNow);
                refreshUI(adjustedNow);
            }
        }

        // è¡Œäº‹æ›†æ¸²æŸ“åŠ å…¥å‡æ—¥é¡è‰²
        function renderCalendar() {
            const y = calViewDate.getFullYear(), m = calViewDate.getMonth();
            document.getElementById('calendar-month-year').innerText = `${y}å¹´ ${m + 1}æœˆ`;
            const first = new Date(y, m, 1).getDay(), last = new Date(y, m + 1, 0).getDate();
            const container = document.getElementById('calendar-days');
            container.innerHTML = '';
            
            const todayStr = new Date().toISOString().split('T')[0];

            for (let i = 0; i < first; i++) container.innerHTML += '<div></div>';
            for (let d = 1; d <= last; d++) {
                const dateStr = `${y}-${(m+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                const holidayLabel = holidays2026[dateStr];
                const hasEvent = dayEvents[dateStr] || reschedules[dateStr];
                const isSelected = selectedDateStr === dateStr;
                
                container.innerHTML += `
                    <div onclick="selectCalendarDay('${dateStr}')" 
                         class="calendar-day p-2 text-sm cursor-pointer ${isSelected ? 'active' : ''} ${hasEvent ? 'has-event' : ''} ${holidayLabel || new Date(dateStr).getDay()===0 || new Date(dateStr).getDay()===6 ? 'holiday' : ''} ${todayStr === dateStr ? 'today' : ''}">
                        ${d}
                    </div>`;
            }
        }

        // (å…¶é¤˜åŸºç¤å‡½æ•¸å¦‚ handleTimers, refreshUI, formatDuration ç­‰ä¿æŒä¸è®Š...)
        function handleTimers(now) {
            const day = now.getDay(), currentTime = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
            const timerEl = document.getElementById('countdown-timer'), labelEl = document.getElementById('status-label');
            let found = false, todayStr = now.toISOString().split('T')[0];
            let lastEnd = 0;
            timeSlots.forEach(s => { if(getLesson(day, s.id, todayStr).name) lastEnd = parseTime(s.end); });

            for (let s of timeSlots) {
                const start = parseTime(s.start), end = parseTime(s.end);
                if (currentTime >= start && currentTime < end) {
                    updateStatus(labelEl, timerEl, "ä¸Šèª²ä¸­", end - currentTime, "text-red-500"); found = true; break;
                }
            }
            if(!found && currentTime >= 43200 && currentTime < 47400) {
                const end = currentTime < 45000 ? 45000 : 47400;
                updateStatus(labelEl, timerEl, currentTime < 45000 ? "æ‰“æƒæ™‚é–“" : "åˆä¼‘æ™‚é–“", end - currentTime, currentTime < 45000 ? "text-amber-500" : "text-blue-500");
                found = true;
            }
            if(!found && currentTime < lastEnd) {
                for(let s of timeSlots) {
                    const start = parseTime(s.start);
                    if(currentTime < start) {
                        const remain = start - currentTime;
                        updateStatus(labelEl, timerEl, remain <= 60 ? "æº–å‚™ä¸Šèª²" : "ä¸‹èª²ä¼‘æ¯", remain, remain <= 60 ? "text-red-500 blink" : "text-green-500");
                        found = true; break;
                    }
                }
            }
            if(!found) { labelEl.innerText = "æ”¾å­¸æ™‚é–“"; labelEl.className = "text-xs font-black text-slate-400"; timerEl.innerText = "--:--"; timerEl.className = "text-4xl font-black text-slate-800 font-mono"; }
        }
        function updateStatus(l, t, txt, rem, cls) { l.innerText = txt; l.className = "text-xs font-black " + cls; t.innerText = formatDuration(rem); t.className = "text-4xl font-black font-mono " + cls; }
        function getLesson(d, sid, date) { return (reschedules[date] && reschedules[date][sid]) ? reschedules[date][sid] : (baseSchedule[`${d}-${sid}`] || {name:""}); }
        function parseTime(str) { const [h, m] = str.split(':').map(Number); return h * 3600 + m * 60; }
        function formatDuration(sec) { return `${Math.floor(sec/60).toString().padStart(2,'0')}:${(sec%60).toString().padStart(2,'0')}`; }
        
        function refreshUI(now) {
            const day = now.getDay(), todayStr = now.toISOString().split('T')[0], timeStr = now.toTimeString().substring(0,5);
            let listHTML = '', cur = null, nxt = null;
            timeSlots.forEach(s => {
                const l = getLesson(day, s.id, todayStr); const isNow = timeStr >= s.start && timeStr < s.end;
                if(isNow) cur = l; if(timeStr < s.start && !nxt && l.name) nxt = l;
                listHTML += `<div class="p-4 rounded-2xl bg-white shadow-sm flex items-center gap-4 ${isNow ? 'is-now' : ''}">
                    <div class="text-center min-w-[60px] font-mono text-xs"><div class="text-slate-400 text-[10px]">${s.start}</div><div class="font-bold text-slate-700">ç¬¬ ${s.id} ç¯€</div></div>
                    <div class="flex-1"><div class="font-bold text-slate-800 text-sm">${l.name || 'ç©ºå ‚'}</div><div class="text-[10px] text-slate-400">${l.teacher || '--'} @ ${l.loc || '--'}</div></div>
                </div>`;
            });
            document.getElementById('schedule-list').innerHTML = listHTML;
            document.getElementById('current-lesson').innerText = cur?.name || "ç›®å‰æ²’èª²";
            document.getElementById('current-teacher').innerText = cur?.teacher || "--";
            document.getElementById('next-lesson').innerText = nxt?.name || "ç„¡ä¸‹ç¯€èª²";
        }

        // è¡Œäº‹æ›†è¼”åŠ©å‡½æ•¸
        function openCalendar() { calViewDate = new Date(); selectedDateStr = new Date().toISOString().split('T')[0]; renderCalendar(); selectCalendarDay(selectedDateStr); openModal('calendarModal'); }
        function changeMonth(s) { calViewDate.setMonth(calViewDate.getMonth() + s); renderCalendar(); }
        function selectCalendarDay(dateStr) { selectedDateStr = dateStr; document.getElementById('selected-date-text').innerText = `é¸æ“‡ï¼š${dateStr} ${holidays2026[dateStr] || ''}`; document.getElementById('cal-note').value = dayEvents[dateStr] || ""; renderCalendar(); }
        function saveDayEvent() { const note = document.getElementById('cal-note').value.trim(); if(note) dayEvents[selectedDateStr] = note; else delete dayEvents[selectedDateStr]; localStorage.setItem('dayEvents', JSON.stringify(dayEvents)); renderCalendar(); alert('å‚™è¨»å·²æ›´æ–°'); }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        setInterval(updateClock, 100); updateClock();
    </script>
</body>
</html>
