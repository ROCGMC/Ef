<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>電一乙週循環課表</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .is-now { border: 3px solid #3b82f6; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20">

    <div class="max-w-md mx-auto p-4">
        <div class="bg-white rounded-3xl p-6 shadow-sm mb-6">
            <div class="flex justify-between items-center mb-4">
                <span id="date-display" class="text-sm font-bold text-slate-400">正在讀取...</span>
                <span id="clock" class="text-lg font-mono font-bold text-slate-800">00:00:00</span>
            </div>

            <div id="now-card" class="mb-4">
                <p class="text-xs font-black text-blue-500 uppercase tracking-widest">Current 當前課程</p>
                <h1 id="current-lesson" class="text-2xl font-bold text-slate-800">目前沒課</h1>
                <p id="current-teacher" class="text-slate-500">--</p>
            </div>
            <div class="border-t border-slate-100 pt-4">
                <p class="text-xs font-black text-slate-400 uppercase tracking-widest">Next 下一節</p>
                <h2 id="next-lesson" class="text-lg font-bold text-slate-700">--</h2>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-8">
            <button onclick="openSetup()" class="bg-slate-800 text-white py-4 rounded-2xl font-bold shadow-lg">設定每週課表</button>
            <button onclick="openModal('rescheduleModal')" class="bg-amber-500 text-white py-4 rounded-2xl font-bold shadow-lg">今日調課</button>
        </div>

        <h3 id="today-title" class="font-bold text-slate-800 mb-4 px-1">今日課表</h3>
        <div id="schedule-list" class="space-y-3"></div>
    </div>

    <div id="setupModal" class="fixed inset-0 bg-black/60 hidden z-50 p-4 flex items-center justify-center">
        <div class="bg-white rounded-3xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-2">設定一週基礎課表</h2>
            <p class="text-sm text-slate-400 mb-4">切換星期來填寫該日的課程內容</p>
            
            <div class="mb-6">
                <select id="edit-day-select" onchange="renderSetupInputs(this.value)" class="w-full p-3 border rounded-xl bg-blue-50 font-bold text-blue-600 border-blue-200">
                    <option value="1">編輯：週一</option>
                    <option value="2">編輯：週二</option>
                    <option value="3">編輯：週三</option>
                    <option value="4">編輯：週四</option>
                    <option value="5">編輯：週五</option>
                </select>
            </div>

            <div id="setup-inputs" class="space-y-3">
                </div>

            <button onclick="saveBaseSchedule()" class="w-full bg-blue-600 text-white py-4 rounded-xl mt-6 font-bold shadow-lg">儲存此日課表</button>
            <button onclick="closeModal('setupModal')" class="w-full text-slate-400 py-2 mt-2">完成並關閉</button>
        </div>
    </div>

    <div id="rescheduleModal" class="fixed inset-0 bg-black/60 hidden z-50 p-4 flex items-center justify-center">
        <div class="bg-white rounded-3xl w-full max-w-md p-6">
            <h2 class="text-xl font-bold mb-4">今日臨時調課</h2>
            <select id="resched-slot" class="w-full p-3 border rounded-xl mb-4 bg-slate-50"></select>
            <input id="resched-name" type="text" placeholder="新的課程名稱" class="w-full p-3 border rounded-xl mb-3">
            <input id="resched-teacher" type="text" placeholder="新的老師名稱" class="w-full p-3 border rounded-xl mb-4">
            <button onclick="saveReschedule()" class="w-full bg-amber-500 text-white py-3 rounded-xl font-bold">確認變更</button>
            <button onclick="closeModal('rescheduleModal')" class="w-full text-slate-400 py-2 mt-2">取消</button>
        </div>
    </div>

    <script>
        // 1. 修正後的東港海事時間資訊
        const timeSlots = [
            { id: 1, start: "08:10", end: "09:00" },
            { id: 2, start: "09:10", end: "10:00" },
            { id: 3, start: "10:10", end: "11:00" },
            { id: 4, start: "11:10", end: "12:00" },
            { id: 5, start: "13:10", end: "14:00" },
            { id: 6, start: "14:10", end: "15:00" },
            { id: 7, start: "15:20", end: "16:10" },
            { id: 8, start: "16:20", end: "17:10" }
        ];

        let baseSchedule = JSON.parse(localStorage.getItem('baseSchedule')) || {};
        let reschedules = JSON.parse(localStorage.getItem('reschedules')) || {};

        function updateClock() {
            const now = new Date();
            const taipeiTime = new Intl.DateTimeFormat('zh-TW', {
                timeZone: 'Asia/Taipei', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
            }).format(now);
            document.getElementById('clock').innerText = taipeiTime;
            
            const days = ["週日", "週一", "週二", "週三", "週四", "週五", "週六"];
            document.getElementById('date-display').innerText = `${now.getMonth()+1}/${now.getDate()} ${days[now.getDay()]}`;
            
            refreshUI();
        }

        function refreshUI() {
            const now = new Date();
            const day = now.getDay(); 
            const currentTime = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            const todayStr = now.toISOString().split('T')[0];

            let currentLesson = null;
            let nextLesson = null;
            let listHTML = '';

            if (day === 0 || day === 6) {
                document.getElementById('schedule-list').innerHTML = '<div class="text-center py-10 text-slate-400">週末放假中 ⛱️</div>';
                return;
            }

            timeSlots.forEach(slot => {
                let lesson = baseSchedule[`${day}-${slot.id}`] || { name: "", teacher: "" };
                
                // 檢查今日有無調課
                if (reschedules[todayStr] && reschedules[todayStr][slot.id]) {
                    lesson = reschedules[todayStr][slot.id];
                }

                const isNow = currentTime >= slot.start && currentTime < slot.end;
                if (isNow) currentLesson = lesson;
                if (currentTime < slot.start && !nextLesson && lesson.name) nextLesson = lesson;

                listHTML += `
                    <div class="p-4 rounded-2xl bg-white shadow-sm flex items-center gap-4 ${isNow ? 'is-now' : ''}">
                        <div class="text-center min-w-[60px]">
                            <div class="text-xs text-slate-400">${slot.start}</div>
                            <div class="font-bold text-slate-700">第 ${slot.id} 節</div>
                        </div>
                        <div class="flex-1">
                            <div class="font-bold text-slate-800">${lesson.name || '空堂'}</div>
                            <div class="text-sm text-slate-400">${lesson.teacher || '--'}</div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('schedule-list').innerHTML = listHTML;
            document.getElementById('current-lesson').innerText = currentLesson?.name || "目前沒課";
            document.getElementById('current-teacher').innerText = currentLesson?.teacher || "--";
            document.getElementById('next-lesson').innerText = nextLesson?.name || "無下節課";
        }

        // --- 設定介面邏輯 ---

        function openSetup() {
            let currentDay = new Date().getDay();
            if (currentDay === 0 || currentDay === 6) currentDay = 1;
            document.getElementById('edit-day-select').value = currentDay;
            renderSetupInputs(currentDay);
            openModal('setupModal');
        }

        function renderSetupInputs(day) {
            let html = '';
            timeSlots.forEach(slot => {
                const data = baseSchedule[`${day}-${slot.id}`] || { name: "", teacher: "" };
                html += `
                    <div class="grid grid-cols-5 gap-2 items-center">
                        <span class="text-sm font-bold text-slate-500">${slot.id}節</span>
                        <input id="input-n-${slot.id}" type="text" value="${data.name}" placeholder="課程名稱" class="col-span-2 p-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        <input id="input-t-${slot.id}" type="text" value="${data.teacher}" placeholder="老師" class="col-span-2 p-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                `;
            });
            document.getElementById('setup-inputs').innerHTML = html;
        }

        function saveBaseSchedule() {
            const day = document.getElementById('edit-day-select').value;
            timeSlots.forEach(slot => {
                baseSchedule[`${day}-${slot.id}`] = {
                    name: document.getElementById(`input-n-${slot.id}`).value,
                    teacher: document.getElementById(`input-t-${slot.id}`).value
                };
            });
            localStorage.setItem('baseSchedule', JSON.stringify(baseSchedule));
            alert(`週 ${day} 的課表已儲存！`);
            refreshUI();
        }

        // --- 調課與基本控制 ---
        function saveReschedule() {
            const slotId = document.getElementById('resched-slot').value;
            const todayStr = new Date().toISOString().split('T')[0];
            if (!reschedules[todayStr]) reschedules[todayStr] = {};
            reschedules[todayStr][slotId] = {
                name: document.getElementById('resched-name').value,
                teacher: document.getElementById('resched-teacher').value
            };
            localStorage.setItem('reschedules', JSON.stringify(reschedules));
            closeModal('rescheduleModal');
        }

        function openModal(id) { 
            document.getElementById(id).classList.remove('hidden'); 
            if(id === 'rescheduleModal') {
                let options = '';
                timeSlots.forEach(s => options += `<option value="${s.id}">第 ${s.id} 節</option>`);
                document.getElementById('resched-slot').innerHTML = options;
            }
        }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        setInterval(updateClock, 1000);
        updateClock();
    </script>
</body>
</html>
