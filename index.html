<!doctype html>
<html lang="zh-TW" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="è³‡ç”¢ç®¡ç†">
  <meta name="theme-color" content="#0a0a0a">
  <meta name="description" content="åœ‹å®¶å®‰å…¨å±€æƒ…å ±å›è¦†ç³»çµ± - è³‡ç”¢ç®¡ç†æ‡‰ç”¨">
  <meta name="application-name" content="åœ‹å®¶å®‰å…¨å±€æƒ…å ±å›è¦†ç³»çµ±">
  <meta name="msapplication-TileColor" content="#0a0a0a">
  <meta name="msapplication-config" content="none">
  <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIuS6kOi5qOaYjumZryDlrZfmsLTnsbvnqIvnkIbpnIDopoHkurrkuK3nn63kuK3nqIvpn5LlvIXnuqfov5nkuI3mgJ3mlLblpKflpIfnp4siLAogICJzaG9ydF9uYW1lIjogIuWtl+awuCDmm7/lpJfigpxBc3NldCBNZ21ugpwiLAogICJzdGFydF91cmwiOiAiLyIsCiAgInNjb3BlIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwYTBhMGEiLAogICJ0aGVtZV9jb2xvciI6ICIjMjJjNTVlIiwKICAib3JpZW50YXRpb24iOiAicG9ydHJhaXQtcHJpbWFyeSIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjRiV3h1Y3oxbElIZHBaSFJvUFNJeE16TTBJaUJvWldsbmFIUTlJakV6TXpRaUlIWnBaWGRDYjNnOUlqQWdNQ0F3TVRJeE1DQXdNVEl4UEM5MGVHRnNiRzl1Ymk5bWIyOTBJSFJsZW1GdmJGUjVjR1U5Wm1Gc2MyVSIsCiAgICAgICJzaXplcyI6ICI5Mng5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiLAogICAgICAicHVycG9zZSI6ICJhbnkiCiAgICB9LAogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjRiV3h1Y3oxbElIZHBaSFJvUFNJeE16TTBJaUJvWldsbmFIUTlJakV6TXpRaUlIWnBaWGRDYjNnOUlqQWdNQ0F3TVRJeE1DQXdNVEl4UEM5MGVHRnNiRzl1Ymk5bWIyOTBJSFJsZW1GdmJGUjVjR1U5Wm1Gc2MyVSIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIsCiAgICAgICJwdXJwb3NlIjogImFueSIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejFsSUhkcFpIUm9QU0l4TXpNMElpQm9aV2xuYUhROUlqRXpNelFpSUhacFpYZENiM2c5SWpBZ01DQXdNVEl4TUNBd01USXhQQzlwYld4dWMyaHZjeTltYjI5MElIUmxlbUZ2YkZSNWNHVTlaV1J6YkcxbCIsCiAgICAgICJzaXplcyI6ICI5Mg3eDkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIsCiAgICAgICJwdXJwb3NlIjogImFueSIKICAgIH0KICBDLCAKICAGIMNHDGVNB3JpZXMiOiBbImZpbmFuY2UiXQp9Ig==" as="fetch">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%230a0a0a' width='180' height='180' rx='40'/><circle cx='90' cy='90' r='65' fill='%2322c55e' opacity='0.8'/><text x='90' y='102' font-size='56' font-weight='bold' fill='%23000' text-anchor='middle' font-family='Orbitron'>$</text></svg>">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%230a0a0a' width='192' height='192'/><circle cx='96' cy='96' r='70' fill='%2322c55e' opacity='0.8'/><text x='96' y='108' font-size='60' font-weight='bold' fill='%23000' text-anchor='middle' font-family='Orbitron'>$</text></svg>">
  <title>åœ‹å®¶å®‰å…¨å±€æƒ…å ±å›è¦†ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&amp;family=Orbitron:wght@400;700&amp;display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Noto Sans TC', sans-serif; }
    .font-digital { font-family: 'Orbitron', monospace; }
    
    @keyframes scanline {
      0% { transform: translateY(-100%); }
      100% { transform: translateY(100%); }
    }
    
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.3); }
      50% { box-shadow: 0 0 40px rgba(34, 197, 94, 0.6); }
    }
    
    @keyframes typing {
      from { width: 0; }
      to { width: 100%; }
    }
    
    @keyframes blink {
      50% { border-color: transparent; }
    }
    
    .scanline {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(to bottom, transparent, rgba(34, 197, 94, 0.1), transparent);
      animation: scanline 3s linear infinite;
      pointer-events: none;
      z-index: 100;
    }
    
    .pulse-border {
      animation: pulse-glow 2s ease-in-out infinite;
    }
    
    .typing-effect {
      overflow: hidden;
      white-space: nowrap;
      border-right: 2px solid #22c55e;
      animation: typing 2s steps(30) forwards, blink 0.7s step-end infinite;
    }
    
    .glass-dark {
      background: rgba(20, 20, 20, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(34, 197, 94, 0.2);
    }
    
    .btn-classified {
      background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
      border: 1px solid #22c55e;
      transition: all 0.3s ease;
    }
    
    .btn-classified:hover {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color: #000;
    }
    
    .btn-classified:active {
      transform: scale(0.98);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
      border: 1px solid #ef4444;
    }
    
    .btn-danger:hover {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: #000;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.3);
    }
    
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0a0a0a; }
    ::-webkit-scrollbar-thumb { background: #22c55e; border-radius: 3px; }
    
    body, html {
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      -webkit-app-region: no-drag;
    }
    
    input, textarea, select {
      -webkit-user-select: text;
    }
    
    @supports (padding: max(0px)) {
      body {
        padding-left: max(12px, env(safe-area-inset-left));
        padding-right: max(12px, env(safe-area-inset-right));
        padding-top: max(12px, env(safe-area-inset-top));
        padding-bottom: max(12px, env(safe-area-inset-bottom));
      }
    }
  </style>
  <style>body { box-sizing: border-box; }</style>
 </head>
 <body class="h-full bg-black text-green-500 overflow-auto">
  <div class="scanline"></div><!-- é©—è­‰é é¢ -->
  <div id="auth-screen" class="h-full flex flex-col items-center justify-center p-6">
   <div class="glass-dark rounded-lg p-8 max-w-md w-full text-center"><!-- Logo -->
    <div class="mb-6"><img src="https://upload.wikimedia.org/wikipedia/zh/2/24/ROC_National_Security_Bureau_Seal.svg" alt="åœ‹å®¶å®‰å…¨å±€å¾½ç« " class="w-24 h-24 mx-auto mb-4 opacity-90" loading="lazy" onerror="console.error('Image failed to load:', this.src); this.style.display='none';">
     <h1 class="text-xl font-bold text-green-400 tracking-wider">åœ‹å®¶å®‰å…¨å±€</h1>
     <p class="text-sm text-green-600 mt-1">NATIONAL SECURITY BUREAU</p>
    </div>
    <div class="border-t border-green-900 my-6"></div>
    <h2 class="text-lg font-medium text-green-300 mb-2">æƒ…å ±å›è¦†ç³»çµ±</h2>
    <p class="text-xs text-green-700 mb-6">INTELLIGENCE RESPONSE SYSTEM v3.2.1</p>
    <div class="mb-6">
     <p class="text-xs text-yellow-500 mb-4">âš  æœ¬ç³»çµ±åƒ…ä¾›æˆæ¬Šäººå“¡ä½¿ç”¨</p><label class="block text-left text-sm text-green-400 mb-2">è«‹è¼¸å…¥æˆæ¬Šç¢¼</label> <input type="password" id="auth-code" class="w-full bg-black border border-green-800 rounded px-4 py-3 text-green-400 font-digital tracking-widest text-center" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="6">
    </div><button id="auth-btn" class="btn-classified w-full py-3 rounded text-green-400 font-medium tracking-wider"> èº«ä»½é©—è­‰ </button>
    <p class="text-xs text-green-800 mt-6">æœªç¶“æˆæ¬Šå­˜å–å°‡ä¾æ³•è¿½è¨´</p>
   </div>
  </div><!-- ä¸»æ‡‰ç”¨ç¨‹å¼ -->
  <div id="main-app" class="h-full flex flex-col hidden"><!-- é ‚éƒ¨å°èˆª -->
   <header class="glass-dark p-4 flex items-center justify-between sticky top-0 z-40">
    <div>
     <h1 id="app-title" class="text-lg font-bold text-green-400">è³‡ç”¢ç®¡ç†ç³»çµ±</h1>
     <p class="text-xs text-green-700">ASSET MANAGEMENT</p>
    </div><button id="logout-btn" class="text-red-500 text-sm hover:text-red-400 px-4 py-2 rounded border border-red-800"> ğŸ”’ ç™»å‡º </button>
   </header><!-- ç¸½é¡é¡¯ç¤º -->
   <div class="p-4">
    <div class="glass-dark rounded-lg p-6 pulse-border">
     <p class="text-xs text-green-600 mb-1">ç¸½è³‡ç”¢é¤˜é¡</p>
     <p id="total-balance" class="text-3xl font-digital font-bold text-green-400">NT$ 0</p>
     <div class="flex gap-4 mt-4 text-sm">
      <div>
       <p class="text-green-700">éˆ”ç¥¨</p>
       <p id="cash-total" class="font-digital text-green-400">NT$ 0</p>
      </div>
      <div>
       <p class="text-green-700">é›¶éŒ¢</p>
       <p id="coin-total" class="font-digital text-green-400">NT$ 0</p>
      </div>
     </div>
    </div>
   </div><!-- æ¨™ç±¤åˆ‡æ› -->
   <div class="px-4 flex gap-2"><button id="tab-wallet" class="flex-1 py-2 rounded bg-green-900 text-green-400 text-sm font-medium"> éŒ¢åŒ…ä¸€è¦½ </button> <button id="tab-deposit" class="flex-1 py-2 rounded bg-transparent border border-green-800 text-green-600 text-sm"> å­˜å…¥è³‡ç”¢ </button>
   </div><!-- éŒ¢åŒ…ä¸€è¦½å…§å®¹ -->
   <div id="wallet-view" class="flex-1 p-4 overflow-auto">
    <div id="wallet-list" class="space-y-3"><!-- å‹•æ…‹å…§å®¹ -->
    </div>
    <div id="empty-state" class="text-center py-12 text-green-700 hidden">
     <p class="text-4xl mb-4">ğŸ“‚</p>
     <p>å°šç„¡è³‡ç”¢è¨˜éŒ„</p>
     <p class="text-sm">è«‹é»æ“Šã€Œå­˜å…¥è³‡ç”¢ã€æ–°å¢</p>
    </div>
   </div><!-- å­˜å…¥è³‡ç”¢å…§å®¹ -->
   <div id="deposit-view" class="flex-1 p-4 overflow-auto hidden">
    <div class="glass-dark rounded-lg p-6">
     <h3 class="text-green-400 font-medium mb-4">æ–°å¢è³‡ç”¢</h3><!-- é¡å‹é¸æ“‡ -->
     <div class="mb-4"><label class="block text-sm text-green-600 mb-2">è³‡ç”¢é¡å‹</label>
      <div class="flex gap-2"><button id="type-cash" class="flex-1 py-3 rounded bg-green-900 text-green-400 border border-green-700"> ğŸ’µ éˆ”ç¥¨ </button> <button id="type-coin" class="flex-1 py-3 rounded bg-transparent text-green-600 border border-green-800"> ğŸª™ é›¶éŒ¢ </button>
      </div>
     </div><!-- é¢é¡é¸æ“‡ -->
     <div class="mb-4"><label class="block text-sm text-green-600 mb-2">é¢é¡</label> <select id="denomination" class="w-full bg-black border border-green-800 rounded px-4 py-3 text-green-400"> <option value="100">NT$ 100</option> <option value="200">NT$ 200</option> <option value="500">NT$ 500</option> <option value="1000">NT$ 1,000</option> <option value="2000">NT$ 2,000</option> </select>
     </div><!-- ç·¨è™Ÿ -->
     <div class="mb-4"><label class="block text-sm text-green-600 mb-2">ç·¨è™Ÿ/åºè™Ÿï¼ˆé¸å¡«ï¼‰</label> <input type="text" id="serial-number" class="w-full bg-black border border-green-800 rounded px-4 py-3 text-green-400" placeholder="è¼¸å…¥ç·¨è™Ÿ...">
     </div><!-- å‚™è¨» -->
     <div class="mb-6"><label class="block text-sm text-green-600 mb-2">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label> <input type="text" id="notes" class="w-full bg-black border border-green-800 rounded px-4 py-3 text-green-400" placeholder="è¼¸å…¥å‚™è¨»...">
     </div><button id="deposit-btn" class="btn-classified w-full py-3 rounded text-green-400 font-medium"> ç¢ºèªå­˜å…¥ </button>
    </div>
   </div>
  </div>
  <script>
    // é…ç½®
    const defaultConfig = {
      app_title: 'è³‡ç”¢ç®¡ç†ç³»çµ±'
    };

    let walletData = [];
    let currentType = 'cash';
    let isAuthenticated = false;
    
    const cashDenominations = [
      { value: 100, label: 'NT$ 100' },
      { value: 200, label: 'NT$ 200' },
      { value: 500, label: 'NT$ 500' },
      { value: 1000, label: 'NT$ 1,000' },
      { value: 2000, label: 'NT$ 2,000' }
    ];
    
    const coinDenominations = [
      { value: 1, label: 'NT$ 1' },
      { value: 5, label: 'NT$ 5' },
      { value: 10, label: 'NT$ 10' },
      { value: 20, label: 'NT$ 20' },
      { value: 50, label: 'NT$ 50' }
    ];

    // è³‡æ–™è™•ç†
    const dataHandler = {
      onDataChanged(data) {
        walletData = data;
        renderWallet();
        updateTotals();
      }
    };

    // åˆå§‹åŒ–
    async function init() {
      // åˆå§‹åŒ– Element SDK
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            document.getElementById('app-title').textContent = config.app_title || defaultConfig.app_title;
          },
          mapToCapabilities: (config) => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ['app_title', config.app_title || defaultConfig.app_title]
          ])
        });
      }

      // åˆå§‹åŒ– Data SDK
      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          console.error('Data SDK init failed');
        }
      }

      setupEventListeners();
    }

    function setupEventListeners() {
      // é©—è­‰
      document.getElementById('auth-btn').addEventListener('click', authenticate);
      document.getElementById('auth-code').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') authenticate();
      });

      // ç™»å‡º
      document.getElementById('logout-btn').addEventListener('click', logout);

      // æ¨™ç±¤åˆ‡æ›
      document.getElementById('tab-wallet').addEventListener('click', () => switchTab('wallet'));
      document.getElementById('tab-deposit').addEventListener('click', () => switchTab('deposit'));

      // é¡å‹é¸æ“‡
      document.getElementById('type-cash').addEventListener('click', () => selectType('cash'));
      document.getElementById('type-coin').addEventListener('click', () => selectType('coin'));

      // å­˜å…¥
      document.getElementById('deposit-btn').addEventListener('click', deposit);
    }

    function authenticate() {
      const code = document.getElementById('auth-code').value;
      if (code.length >= 4) {
        isAuthenticated = true;
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
      } else {
        document.getElementById('auth-code').style.borderColor = '#ef4444';
        setTimeout(() => {
          document.getElementById('auth-code').style.borderColor = '';
        }, 1000);
      }
    }

    function logout() {
      isAuthenticated = false;
      document.getElementById('auth-code').value = '';
      document.getElementById('main-app').classList.add('hidden');
      document.getElementById('auth-screen').classList.remove('hidden');
    }

    function switchTab(tab) {
      const walletTab = document.getElementById('tab-wallet');
      const depositTab = document.getElementById('tab-deposit');
      const walletView = document.getElementById('wallet-view');
      const depositView = document.getElementById('deposit-view');

      if (tab === 'wallet') {
        walletTab.className = 'flex-1 py-2 rounded bg-green-900 text-green-400 text-sm font-medium';
        depositTab.className = 'flex-1 py-2 rounded bg-transparent border border-green-800 text-green-600 text-sm';
        walletView.classList.remove('hidden');
        depositView.classList.add('hidden');
      } else {
        depositTab.className = 'flex-1 py-2 rounded bg-green-900 text-green-400 text-sm font-medium';
        walletTab.className = 'flex-1 py-2 rounded bg-transparent border border-green-800 text-green-600 text-sm';
        depositView.classList.remove('hidden');
        walletView.classList.add('hidden');
      }
    }

    function selectType(type) {
      currentType = type;
      const cashBtn = document.getElementById('type-cash');
      const coinBtn = document.getElementById('type-coin');
      const select = document.getElementById('denomination');

      if (type === 'cash') {
        cashBtn.className = 'flex-1 py-3 rounded bg-green-900 text-green-400 border border-green-700';
        coinBtn.className = 'flex-1 py-3 rounded bg-transparent text-green-600 border border-green-800';
        select.innerHTML = cashDenominations.map(d => 
          `<option value="${d.value}">${d.label}</option>`
        ).join('');
      } else {
        coinBtn.className = 'flex-1 py-3 rounded bg-green-900 text-green-400 border border-green-700';
        cashBtn.className = 'flex-1 py-3 rounded bg-transparent text-green-600 border border-green-800';
        select.innerHTML = coinDenominations.map(d => 
          `<option value="${d.value}">${d.label}</option>`
        ).join('');
      }
    }

    async function deposit() {
      if (walletData.length >= 999) {
        showMessage('å·²é”åˆ°å„²å­˜ä¸Šé™ï¼ˆ999ç­†ï¼‰');
        return;
      }

      const btn = document.getElementById('deposit-btn');
      btn.textContent = 'è™•ç†ä¸­...';
      btn.disabled = true;

      const denomination = parseInt(document.getElementById('denomination').value);
      const serialNumber = document.getElementById('serial-number').value.trim();
      const notes = document.getElementById('notes').value.trim();

      const record = {
        id: Date.now().toString(),
        type: currentType,
        denomination: denomination,
        serial_number: serialNumber || generateSerial(),
        deposit_time: new Date().toISOString(),
        notes: notes
      };

      if (window.dataSdk) {
        const result = await window.dataSdk.create(record);
        if (result.isOk) {
          document.getElementById('serial-number').value = '';
          document.getElementById('notes').value = '';
          showMessage('è³‡ç”¢å·²æˆåŠŸå­˜å…¥');
          switchTab('wallet');
        } else {
          showMessage('å­˜å…¥å¤±æ•—ï¼Œè«‹é‡è©¦');
        }
      }

      btn.textContent = 'ç¢ºèªå­˜å…¥';
      btn.disabled = false;
    }

    function generateSerial() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let serial = '';
      for (let i = 0; i < 8; i++) {
        serial += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return serial;
    }

    window.withdraw = function(record) {
      const item = document.querySelector(`[data-id="${record.id}"]`);
      if (item) {
        const confirmBtn = item.querySelector('.confirm-withdraw');
        if (confirmBtn) {
          // å·²é¡¯ç¤ºç¢ºèªæŒ‰éˆ•ï¼ŒåŸ·è¡Œå–å‡º
          if (window.dataSdk) {
            const deleteRecord = walletData.find(r => r.id === record.id);
            if (deleteRecord) {
              window.dataSdk.delete(deleteRecord).catch(err => {
                showMessage('å–å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦');
              });
            }
          }
        } else {
          // é¡¯ç¤ºç¢ºèªæŒ‰éˆ•
          const withdrawBtn = item.querySelector('.withdraw-btn');
          if (withdrawBtn) {
            withdrawBtn.outerHTML = `
              <div class="flex gap-2">
                <button class="confirm-withdraw px-3 py-1 bg-red-900 text-red-400 rounded text-xs" onclick="confirmDelete('${record.id}')">ç¢ºèªå–å‡º</button>
                <button class="px-3 py-1 bg-green-900 text-green-400 rounded text-xs" onclick="cancelWithdraw('${record.id}')">å–æ¶ˆ</button>
              </div>
            `;
          }
        }
      }
    };

    window.confirmDelete = function(id) {
      const record = walletData.find(r => r.id === id);
      if (record && window.dataSdk) {
        window.dataSdk.delete(record).catch(err => {
          showMessage('å–å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦');
        });
      }
    };

    window.cancelWithdraw = function(id) {
      renderWallet();
    };

    function renderWallet() {
      const list = document.getElementById('wallet-list');
      const empty = document.getElementById('empty-state');

      if (walletData.length === 0) {
        list.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }

      empty.classList.add('hidden');

      // æŒ‰å­˜å…¥æ™‚é–“æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
      const sorted = [...walletData].sort((a, b) => 
        new Date(b.deposit_time) - new Date(a.deposit_time)
      );

      list.innerHTML = sorted.map(item => {
        const date = new Date(item.deposit_time);
        const dateStr = date.toLocaleDateString('zh-TW');
        const timeStr = date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
        const icon = item.type === 'cash' ? 'ğŸ’µ' : 'ğŸª™';
        const typeLabel = item.type === 'cash' ? 'éˆ”ç¥¨' : 'é›¶éŒ¢';

        return `
          <div class="glass-dark rounded-lg p-4" data-id="${item.id}">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <span class="text-2xl">${icon}</span>
                <div>
                  <p class="font-digital text-green-400 text-lg">NT$ ${item.denomination.toLocaleString()}</p>
                  <p class="text-xs text-green-700">${typeLabel}</p>
                </div>
              </div>
              <button class="withdraw-btn btn-danger px-3 py-1 rounded text-red-400 text-sm" onclick="withdraw(walletData.find(r => r.id === '${item.id}'))">
                å–å‡º
              </button>
            </div>
            <div class="mt-3 pt-3 border-t border-green-900 text-xs text-green-600">
              <div class="flex justify-between mb-1">
                <span>ç·¨è™Ÿ</span>
                <span class="font-digital text-green-500">${item.serial_number}</span>
              </div>
              <div class="flex justify-between mb-1">
                <span>å­˜å…¥æ™‚é–“</span>
                <span>${dateStr} ${timeStr}</span>
              </div>
              ${item.notes ? `
              <div class="flex justify-between">
                <span>å‚™è¨»</span>
                <span class="text-green-500">${item.notes}</span>
              </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function updateTotals() {
      const cashItems = walletData.filter(item => item.type === 'cash');
      const coinItems = walletData.filter(item => item.type === 'coin');

      const cashTotal = cashItems.reduce((sum, item) => sum + item.denomination, 0);
      const coinTotal = coinItems.reduce((sum, item) => sum + item.denomination, 0);
      const total = cashTotal + coinTotal;

      document.getElementById('total-balance').textContent = `NT$ ${total.toLocaleString()}`;
      document.getElementById('cash-total').textContent = `NT$ ${cashTotal.toLocaleString()}`;
      document.getElementById('coin-total').textContent = `NT$ ${coinTotal.toLocaleString()}`;
    }

    function showMessage(msg) {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-green-900 text-green-400 px-6 py-3 rounded-lg text-sm z-50 max-w-xs text-center';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    }

    // è¨»å†Š Service Worker (PWA)
    if ('serviceWorker' in navigator) {
      const swCode = `
        const CACHE_NAME = 'intelligence-v1';
        const urlsToCache = ['/'];

        self.addEventListener('install', event => {
          self.skipWaiting();
        });

        self.addEventListener('activate', event => {
          event.waitUntil(clients.claim());
          caches.delete(CACHE_NAME);
        });

        self.addEventListener('fetch', event => {
          if (event.request.method !== 'GET') {
            return;
          }
          event.respondWith(
            caches.open(CACHE_NAME).then(cache => {
              return fetch(event.request).then(response => {
                cache.put(event.request, response.clone());
                return response;
              }).catch(() => {
                return caches.match(event.request);
              });
            })
          );
        });
      `;

      const blob = new Blob([swCode], { type: 'application/javascript' });
      const swUrl = URL.createObjectURL(blob);

      navigator.serviceWorker.register(swUrl, { scope: '/' })
        .then(reg => {
          console.log('âœ“ Service Worker registered');
        })
        .catch(err => {
          console.log('Service Worker registration error:', err);
        });
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9d1e303390a83323',t:'MTc3MTc2MDIxMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>