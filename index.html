<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§å‹•æ…‹èª²è¡¨ç³»çµ± V4</title>
    <link href="https://fonts.cdnfonts.com/css/digital-7-mono" rel="stylesheet">
    <style>
        :root { --primary: #2196F3; --accent: #00ff41; --bg: #000; --red: #ff3b30; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #eee; }
        
        .dashboard { background: #000; padding: 20px 15px; border-radius: 20px; text-align: center; margin-bottom: 15px; border: 2px solid #222; position: relative; }
        
        /* æ•¸ä½å­—é«”é¢¨æ ¼ */
        .digital { font-family: 'Digital-7 Mono', sans-serif; }
        #countdown { font-size: 5rem; color: var(--accent); text-shadow: 0 0 15px rgba(0, 255, 65, 0.4); margin: 5px 0; }
        #real-time { font-size: 1.5rem; color: var(--red); text-shadow: 0 0 10px rgba(255, 59, 48, 0.4); }
        #full-date { font-size: 1rem; color: #888; margin-top: 5px; }
        
        /* é¸å–®æŒ‰éˆ• */
        .menu-btn { position: absolute; top: 20px; right: 20px; background: none; border: none; cursor: pointer; z-index: 10; }
        .menu-btn div { width: 25px; height: 3px; background: white; margin: 5px 0; }

        /* è¡¨æ ¼èˆ‡è¡Œäº‹æ›† */
        .table-card { background: #111; border-radius: 15px; overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 450px; }
        th, td { border: 1px solid #222; padding: 12px 5px; text-align: center; font-size: 14px; }
        .active-cell { background-color: rgba(0, 255, 65, 0.15) !important; color: var(--accent); font-weight: bold; }
        
        /* å½ˆçª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; overflow-y: auto; }
        .modal-body { background: #1a1a1a; margin: 20px auto; padding: 25px; width: 90%; max-width: 500px; border-radius: 20px; }
        input, textarea, select { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: white; border-radius: 10px; margin: 10px 0; box-sizing: border-box; }
        
        /* è¡Œäº‹æ›†å°ˆç”¨ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .calendar-day { padding: 8px 0; border-radius: 5px; font-size: 12px; cursor: pointer; background: #222; }
        .holiday { color: var(--red); font-weight: bold; }
        .has-note { border-bottom: 2px solid var(--primary); }
    </style>
</head>
<body>

<div class="dashboard">
    <button class="menu-btn" onclick="toggleModal('menuModal')"><div></div><div></div><div></div></button>
    <div id="full-date">2026 / 02 / 27</div>
    <div id="countdown" class="digital">00:00:00</div>
    <div id="real-time" class="digital">00:00:00</div>
    <div style="font-size: 11px; color: #444; margin-top:10px;">å°åŒ—æ¨™æº–æ™‚é–“ (TPE)</div>
</div>

<select id="classSelector" onchange="switchClass()"></select>

<div id="holiday-msg" style="display:none; text-align:center; padding:20px; color:var(--accent); font-weight:bold;">âœ¨ åœ‹å®šå‡æ—¥ï¼Œæ”¾å‡ä¸€å¤© âœ¨</div>
<div class="table-card" id="tableBox"></div>

<div id="menuModal" class="modal">
    <div class="modal-body">
        <h3>âš™ï¸ æ§åˆ¶ä¸­å¿ƒ</h3>
        <label>æ™‚é–“å¾®èª¿ (è¼¸å…¥ç§’æ•¸ï¼Œä¾‹å¦‚ 2 æˆ– -2)ï¼š</label>
        <input type="number" id="offsetInput" placeholder="0" onchange="setOffset(this.value)">
        
        <button onclick="toggleModal('calModal')" style="width:100%; background:var(--primary); color:white; padding:15px; border-radius:10px; border:none; margin:10px 0;">ğŸ“… é–‹å•Ÿæ ¡åœ’è¡Œäº‹æ›†</button>
        
        <hr style="border-color:#333">
        <h4>ğŸ” æ•™å¸«è¿½è¹¤</h4>
        <input type="text" id="tQuery" placeholder="è¼¸å…¥è€å¸«..." oninput="searchT()">
        <div id="searchRes" style="font-size:13px; color:var(--accent); min-height:40px;"></div>

        <hr style="border-color:#333">
        <h4>ğŸ› ï¸ è³‡æ–™åº«ç·¨è¼¯</h4>
        <textarea id="jsonInput" style="height:100px;"></textarea>
        <button onclick="importJSON()" style="width:100%; background:var(--accent); color:#000; padding:10px; border:none; font-weight:bold;">å„²å­˜è³‡æ–™åº«</button>
        <button onclick="toggleModal('menuModal')" style="width:100%; margin-top:20px; background:#444; border:none; color:white;">é—œé–‰</button>
    </div>
</div>

<div id="calModal" class="modal">
    <div class="modal-body">
        <h3 id="calTitle">2026 / 02</h3>
        <div class="calendar-grid" id="calGrid"></div>
        <hr style="border-color:#333">
        <div id="noteArea" style="display:none;">
            <p id="selectedDateText"></p>
            <textarea id="dayNote" placeholder="è¼¸å…¥ç•¶å¤©å‚™è¨»..."></textarea>
            <button onclick="saveNote()" style="background:var(--primary); color:white; border:none; padding:10px; border-radius:5px;">å„²å­˜å‚™è¨»</button>
        </div>
        <button onclick="toggleModal('calModal')" style="width:100%; margin-top:20px; background:#444; border:none; color:white;">è¿”å›</button>
    </div>
</div>

<script>
    // é è¨­è³‡æ–™
    let fullDB = JSON.parse(localStorage.getItem('full_database')) || { "é›»ä¸€ä¹™": Array.from({length:7},()=>Array(5).fill("æœªè¨­å®š")) };
    let timeOffset = parseInt(localStorage.getItem('time_offset')) || 0;
    let notes = JSON.parse(localStorage.getItem('day_notes')) || {};
    let currentClass = localStorage.getItem('current_class') || Object.keys(fullDB)[0];
    let selectedDate = "";

    const slots = [
        { s: "08:10", e: "09:00" }, { s: "09:10", e: "10:00" }, { s: "10:10", e: "11:00" },
        { s: "11:10", e: "12:00" }, { s: "13:10", e: "14:00" }, { s: "14:10", e: "15:00" }, { s: "15:20", e: "16:10" }
    ];

    // åœ‹å®šå‡æ—¥åˆ¤å®š (ç¯„ä¾‹ï¼š2026å¹´)
    const holidays = ["2026-01-01", "2026-02-17", "2026-02-28", "2026-04-04", "2026-05-01", "2026-06-19", "2026-10-10"];

    function init() {
        updateSelector();
        renderTable();
        renderCalendar();
        setInterval(tick, 1000);
        document.getElementById('offsetInput').value = timeOffset;
        document.getElementById('jsonInput').value = JSON.stringify(fullDB, null, 2);
    }

    function tick() {
        const now = new Date();
        const localNow = new Date(now.getTime() + timeOffset * 1000);
        
        // é¡¯ç¤ºæ—¥æœŸèˆ‡æ™‚é–“
        document.getElementById('full-date').innerText = localNow.toLocaleDateString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit'});
        document.getElementById('real-time').innerText = localNow.toTimeString().split(' ')[0];
        
        const sec = localNow.getHours() * 3600 + localNow.getMinutes() * 60 + localNow.getSeconds();
        const day = localNow.getDay();
        const dateStr = localNow.toISOString().split('T')[0];

        // å‡æ—¥åˆ¤å®š
        const isHoliday = (day === 0 || day === 6 || holidays.includes(dateStr));
        document.getElementById('holiday-msg').style.display = isHoliday ? "block" : "none";
        document.getElementById('tableBox').style.display = isHoliday ? "none" : "block";

        // å€’æ•¸è¨ˆæ™‚é‚è¼¯
        let curP = -1, cdVal = 0;
        slots.forEach((o, i) => {
            const startS = toSec(o.s), endS = toSec(o.e);
            if (sec >= startS && sec < endS) { curP = i; cdVal = endS - sec; }
            else if (sec < startS && cdVal === 0) { cdVal = startS - sec; }
        });

        document.getElementById('countdown').innerText = formatTime(cdVal);
        
        // æ›´æ–°è¡¨æ ¼äº®é»
        document.querySelectorAll('td').forEach(c => c.classList.remove('active-cell'));
        if (curP !== -1 && day >= 1 && day <= 5 && !isHoliday) {
            const rowIdx = curP + (curP >= 4 ? 2 : 1);
            const targetRow = document.querySelectorAll('tr')[rowIdx];
            if (targetRow) targetRow.cells[day].classList.add('active-cell');
        }
    }

    function formatTime(s) {
        const h = Math.floor(s / 3600);
        const m = Math.floor((s % 3600) / 60);
        const sec = s % 60;
        return (h > 0 ? `${h}:` : "") + `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    }

    // è¡Œäº‹æ›†é‚è¼¯
    function renderCalendar() {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();
        document.getElementById('calTitle').innerText = `${year} / ${String(month+1).padStart(2,'0')}`;
        
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        let html = "";
        for(let i=0; i<firstDay; i++) html += `<div></div>`;
        for(let d=1; d<=daysInMonth; d++) {
            const dStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const isH = holidays.includes(dStr);
            const hasN = notes[dStr] ? "has-note" : "";
            html += `<div class="calendar-day ${isH?'holiday':''} ${hasN}" onclick="openNote('${dStr}')">${d}</div>`;
        }
        document.getElementById('calGrid').innerHTML = html;
    }

    function openNote(d) {
        selectedDate = d;
        document.getElementById('noteArea').style.display = "block";
        document.getElementById('selectedDateText').innerText = d;
        document.getElementById('dayNote').value = notes[d] || "";
    }

    function saveNote() {
        notes[selectedDate] = document.getElementById('dayNote').value;
        localStorage.setItem('day_notes', JSON.stringify(notes));
        alert("å‚™è¨»å·²å„²å­˜");
        renderCalendar();
    }

    function setOffset(v) {
        timeOffset = parseInt(v) || 0;
        localStorage.setItem('time_offset', timeOffset);
    }

    function searchT() {
        const q = document.getElementById('tQuery').value.trim();
        if(!q) return document.getElementById('searchRes').innerHTML = "";
        const now = new Date(Date.now() + timeOffset * 1000);
        const sec = now.getHours()*3600 + now.getMinutes()*60;
        let curP = -1, nextP = -1;
        slots.forEach((o, i) => { 
            if(sec >= toSec(o.s) && sec < toSec(o.e)) curP = i;
            if(sec < toSec(o.s) && nextP === -1) nextP = i;
        });
        
        let cPos = "ä¸åœ¨æ•™å®¤", nPos = "æœªçŸ¥";
        Object.keys(fullDB).forEach(cls => {
            if(curP!==-1 && fullDB[cls][curP][now.getDay()-1]?.includes(q)) cPos = cls;
            if(nextP!==-1 && fullDB[cls][nextP][now.getDay()-1]?.includes(q)) nPos = cls;
        });
        document.getElementById('searchRes').innerHTML = `ğŸ“ ç›®å‰ï¼š${cPos} | â­ï¸ ä¸‹ä¸€ç¯€ï¼š${nPos}`;
    }

    // åŸºæœ¬åŠŸèƒ½
    function updateSelector() {
        const sel = document.getElementById('classSelector');
        sel.innerHTML = Object.keys(fullDB).map(cls => `<option value="${cls}" ${cls === currentClass ? 'selected' : ''}>${cls}</option>`).join('');
    }
    function renderTable() {
        let data = fullDB[currentClass];
        let h = `<table><tr><th>ç¯€</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th></tr>`;
        data.forEach((row, pIdx) => {
            if (pIdx === 4) h += `<tr style="background:#111"><td colspan="6">LUNCH</td></tr>`;
            h += `<tr><td>${pIdx + 1}</td>` + row.map(c => `<td>${c.replace('(','<br><small>').replace(')','</small>')}</td>`).join('') + `</tr>`;
        });
        document.getElementById('tableBox').innerHTML = h + `</table>`;
    }
    function switchClass() { currentClass = document.getElementById('classSelector').value; localStorage.setItem('current_class', currentClass); renderTable(); }
    function toSec(t) { const [h, m] = t.split(':'); return h * 3600 + m * 60; }
    function toggleModal(id) { const m = document.getElementById(id); m.style.display = (m.style.display==='block'?'none':'block'); }
    function importJSON() { try { fullDB = JSON.parse(document.getElementById('jsonInput').value); localStorage.setItem('full_database', JSON.stringify(fullDB)); updateSelector(); renderTable(); alert("æˆåŠŸ"); } catch(e){alert("å¤±æ•—");} }
    async function toggleWake(on) { if(on) await navigator.wakeLock.request('screen'); }
    window.onload = init;
</script>
</body>
</html>
