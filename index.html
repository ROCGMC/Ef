<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê†°Ê∫ñÁâàË™≤Ë°® PWA</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 15px; }
        .dashboard { background: #333; color: #fff; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: center; }
        #timer { font-size: 24px; color: #ffeb3b; font-weight: bold; margin: 5px 0; }
        .calibration { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        .cal-btn { background: #555; border: none; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; cursor: pointer; }
        
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .active-row { background-color: #fff9c4; border: 2px solid #fbc02d; box-shadow: inset 0 0 10px rgba(251,192,45,0.3); }
        .next-hint { font-size: 12px; color: #bbb; }
    </style>
</head>
<body>

<div class="dashboard">
    <div id="status">ËÆÄÂèñ‰∏≠...</div>
    <div id="timer">00:00:00</div>
    <div class="next-hint" id="nextHint"></div>
    
    <div class="calibration">
        <button class="cal-btn" onclick="adjustOffset(-10)">-10s</button>
        <button class="cal-btn" onclick="adjustOffset(-1)">-1s</button>
        <span id="offsetDisplay" style="font-size: 12px; align-self: center;">Ê†°Â∞ç: 0s</span>
        <button class="cal-btn" onclick="adjustOffset(1)">+1s</button>
        <button class="cal-btn" onclick="adjustOffset(10)">+10s</button>
    </div>
</div>

<div id="tableContainer"></div>

<script src="data.js"></script>
<script>
    // 1. Ë™≤Ë°®ËàáÊôÇÈñìÂÆöÁæ©
    const timeSlots = [
        { name: "Á¨¨‰∏ÄÁØÄ", start: "08:10", end: "09:00" },
        { name: "Á¨¨‰∫åÁØÄ", start: "09:10", end: "10:00" },
        { name: "Á¨¨‰∏âÁØÄ", start: "10:10", end: "11:00" },
        { name: "Á¨¨ÂõõÁØÄ", start: "11:10", end: "12:00" },
        { name: "Á¨¨‰∫îÁØÄ", start: "13:10", end: "14:00" },
        { name: "Á¨¨ÂÖ≠ÁØÄ", start: "14:10", end: "15:00" },
        { name: "Á¨¨‰∏ÉÁØÄ", start: "15:20", end: "16:10" }
    ];

    // 2. Ê†°Â∞çÈÇèËºØ
    let timeOffset = parseInt(localStorage.getItem('timeOffset')) || 0;

    function adjustOffset(seconds) {
        timeOffset += seconds;
        localStorage.setItem('timeOffset', timeOffset);
        document.getElementById('offsetDisplay').innerText = `Ê†°Â∞ç: ${timeOffset}s`;
    }

    function getSchoolTime() {
        const now = new Date();
        return new Date(now.getTime() + timeOffset * 1000);
    }

    // 3. Ê†∏ÂøÉË®àÊôÇÂô®ËàáÂãïÊÖãÊõ¥Êñ∞
    function updateApp() {
        const schoolTime = getSchoolTime();
        const h = schoolTime.getHours();
        const m = schoolTime.getMinutes();
        const s = schoolTime.getSeconds();
        const totalSeconds = h * 3600 + m * 60 + s;
        const day = schoolTime.getDay(); // 1-5

        // Êõ¥Êñ∞ÊôÇÈêòÈ°ØÁ§∫
        document.getElementById('timer').innerText = 
            `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;

        let currentPeriodIdx = -1;
        let nextPeriodIdx = -1;

        timeSlots.forEach((slot, i) => {
            const [sH, sM] = slot.start.split(':').map(Number);
            const [eH, eM] = slot.end.split(':').map(Number);
            const startSec = sH * 3600 + sM * 60;
            const endSec = eH * 3600 + eM * 60;

            if (totalSeconds >= startSec && totalSeconds < endSec) {
                currentPeriodIdx = i;
                const remain = endSec - totalSeconds;
                document.getElementById('status').innerText = `üîî ${slot.name} ÈÄ≤Ë°å‰∏≠`;
                document.getElementById('nextHint').innerText = `Ë∑ùÈõ¢‰∏ãË™≤ÈÇÑÊúâ ${Math.floor(remain/60)}ÂàÜ${remain%60}Áßí`;
            } else if (totalSeconds < startSec && nextPeriodIdx === -1) {
                nextPeriodIdx = i;
                const wait = startSec - totalSeconds;
                document.getElementById('status').innerText = `‚òï ‰∏ãË™≤‰ºëÊÅØ‰∏≠`;
                document.getElementById('nextHint').innerText = `Ë∑ùÈõ¢ ${slot.name} ÈÇÑÊúâ ${Math.floor(wait/60)}ÂàÜ${wait%60}Áßí`;
            }
        });

        // Â¶ÇÊûúÊîæÂ≠∏‰∫Ü
        if (currentPeriodIdx === -1 && nextPeriodIdx === -1) {
            document.getElementById('status').innerText = "üè† ÊîæÂ≠∏Âõâ / Â∞öÊú™‰∏äË™≤";
            document.getElementById('nextHint').innerText = "";
        }

        // È´ò‰∫ÆË°®Ê†º (ÂÉÖÂú®ÊØèÂàÜÈêòÊõ¥Êñ∞‰∏ÄÊ¨°ÊàñÂàùÂßãËºâÂÖ•)
        refreshTableHighlight(currentPeriodIdx, day);
    }

    function refreshTableHighlight(periodIdx, day) {
        document.querySelectorAll('tr').forEach(r => r.classList.remove('active-row'));
        if (periodIdx !== -1 && day >= 1 && day <= 5) {
            const rows = document.querySelectorAll('#timetable tbody tr:not(.break-row)');
            if(rows[periodIdx]) rows[periodIdx].classList.add('active-row');
        }
    }

    // ÂïüÂãï
    document.getElementById('offsetDisplay').innerText = `Ê†°Â∞ç: ${timeOffset}s`;
    setInterval(updateApp, 1000); // ÊØè‰∏ÄÁßíË∑ë‰∏ÄÊ¨°ÔºåÁ¢∫‰øùÂÄíÊï∏ÊµÅÊö¢
    
    // (ÈÄôË£°Êé•Á∫å‰πãÂâçÁöÑË°®Ê†ºÁîüÊàêÊ∏≤Êüì‰ª£Á¢º renderTable...)
</script>
</body>
</html>
