<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§èª²è¡¨ V5.0 - å…¨åŠŸèƒ½ä¿®å¾©ç‰ˆ</title>
    <link href="https://fonts.cdnfonts.com/css/digital-7-mono" rel="stylesheet">
    <style>
        :root { --primary: #2196F3; --accent: #00ff41; --bg: #000; --red: #ff3b30; --panel: #111; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #eee; overflow-x: hidden; }

        /* å³ä¸Šè§’é¸å–®æŒ‰éˆ• */
        .menu-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; cursor: pointer; padding: 10px; z-index: 1001; }
        .menu-btn div { width: 28px; height: 3px; background: white; margin: 6px 0; border-radius: 2px; }

        /* ä¸­å¤®çœ‹æ¿ */
        .info-board { 
            background: linear-gradient(145deg, #1a1a1a, #000); 
            border: 2px solid #333; border-radius: 25px; padding: 20px; margin-bottom: 15px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .digital { font-family: 'Digital-7 Mono', monospace; line-height: 1; }
        .period-badge { background: var(--primary); color: white; padding: 4px 12px; border-radius: 50px; font-size: 0.9rem; font-weight: bold; }
        #cur-subject { font-size: 2.5rem; color: var(--accent); margin: 10px 0 5px 0; font-weight: bold; }
        #cur-teacher { font-size: 1.3rem; color: #aaa; margin-bottom: 15px; }
        #countdown { font-size: 4.5rem; color: var(--accent); text-shadow: 0 0 15px rgba(0,255,65,0.3); }
        #real-time { font-size: 1.5rem; color: var(--red); margin: 5px 0; }
        #full-date { font-size: 1rem; color: #666; letter-spacing: 2px; }

        /* èª²è¡¨è¡¨æ ¼ */
        .table-card { background: var(--panel); border-radius: 15px; overflow-x: auto; border: 1px solid #222; }
        table { width: 100%; border-collapse: collapse; min-width: 450px; }
        th, td { border: 1px solid #222; padding: 10px 5px; text-align: center; font-size: 13px; }
        .active-cell { background: rgba(0, 255, 65, 0.15) !important; color: var(--accent); font-weight: bold; outline: 1px solid var(--accent); }

        /* å½ˆçª—ç³»çµ± */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; overflow-y: auto; padding-top: 20px; }
        .modal-body { background: #111; margin: 0 auto 40px; padding: 25px; width: 85%; max-width: 500px; border-radius: 20px; border: 1px solid #333; }
        
        textarea, input, select { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: white; border-radius: 10px; margin: 10px 0; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 14px; border-radius: 10px; border: none; font-weight: bold; margin: 5px 0; cursor: pointer; font-size: 16px; }
        
        .btn-green { background: var(--accent); color: #000; }
        .btn-blue { background: var(--primary); color: white; }
        
        /* è¢å¹•é•·äº®é–‹é—œ */
        .switch-container { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; color: #ccc; }
        .toggle { position: relative; display: inline-block; width: 50px; height: 26px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(24px); }

        /* è¡Œäº‹æ›† */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 15px; }
        .cal-day { padding: 10px 0; background: #222; border-radius: 8px; font-size: 13px; cursor: pointer; text-align: center; }
        .note-mark { border-bottom: 3px solid var(--primary); }
    </style>
</head>
<body>

<button class="menu-btn" onclick="toggleModal('menuModal')"><div></div><div></div><div></div></button>

<div class="info-board">
    <div id="full-date" class="digital">Loading...</div>
    <div id="real-time" class="digital">00:00:00</div>
    <div id="holiday-banner" style="display:none; padding:30px; color:var(--accent); font-size:1.5rem;">ğŸï¸ æ”¾å‡ä¸­ / é€±æœ«</div>
    <div id="main-content">
        <div style="margin: 15px 0;"><span class="period-badge" id="period-label">---</span></div>
        <div id="cur-subject">è¼‰å…¥ä¸­</div>
        <div id="cur-teacher">---</div>
        <div id="countdown" class="digital">00:00</div>
    </div>
</div>

<select id="classSelector" onchange="switchClass()"></select>
<div class="table-card" id="tableBox"></div>

<div id="menuModal" class="modal">
    <div class="modal-body">
        <h3 style="color:var(--primary)">æ§åˆ¶ä¸­å¿ƒ</h3>
        
        <div class="switch-container">
            <span>ğŸ’¡ ä¿æŒè¢å¹•å¸¸äº®</span>
            <label class="toggle">
                <input type="checkbox" id="noSleepToggle" onchange="toggleWakeLock(this.checked)">
                <span class="slider"></span>
            </label>
        </div>

        <button class="btn-blue" onclick="openCalendar()">ğŸ“… è¡Œäº‹æ›†å‚™è¨» / æ”¾å‡</button>
        
        <hr style="border-color:#333">
        <h4>ğŸ” æ•™å¸«ä½ç½®è¿½è¹¤</h4>
        <input type="text" id="tSearch" placeholder="è¼¸å…¥è€å¸«åå­—..." oninput="handleSearch()">
        <div id="searchInfo" style="background:#000; padding:10px; border-radius:10px; font-size:14px; color:var(--accent); border:1px solid #333; min-height:40px; white-space: pre-line;"></div>

        <hr style="border-color:#333">
        <h4>ğŸ› ï¸ JSON è³‡æ–™åº«</h4>
        <textarea id="jsonDB" style="height:100px; font-family: monospace;"></textarea>
        <button class="btn-green" onclick="saveDB()">ğŸ’¾ å„²å­˜ä¸¦æ›´æ–°</button>
        <button onclick="toggleModal('menuModal')" style="background:#333; color:white;">é—œé–‰</button>
    </div>
</div>

<div id="calModal" class="modal">
    <div class="modal-body">
        <h3 id="calMonthTitle" style="text-align:center;"></h3>
        <div class="calendar-grid" id="calendarGrid"></div>
        <div id="notePanel" style="display:none; margin-top:15px; background:#000; padding:15px; border-radius:15px;">
            <p id="selDateDisplay" style="color:var(--primary); font-weight:bold;"></p>
            <textarea id="dateNote" style="height:60px;" placeholder="è¼¸å…¥ /æ”¾å‡ è©²å¤©ä¸é¡¯ç¤ºèª²è¡¨"></textarea>
            <button class="btn-blue" onclick="saveNote()">å„²å­˜å‚™è¨»</button>
        </div>
        <button onclick="closeCalendar()" style="background:#333; color:white; margin-top:10px;">è¿”å›é¸å–®</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/nosleep.js@0.12.0/dist/NoSleep.min.js"></script>

<script>
    const slots = [
        { s: "08:10", e: "09:00" }, { s: "09:10", e: "10:00" }, { s: "10:10", e: "11:00" },
        { s: "11:10", e: "12:00" }, { s: "13:10", e: "14:00" }, { s: "14:10", e: "15:00" }, { s: "15:20", e: "16:10" }
    ];

    let db = JSON.parse(localStorage.getItem('edu_db')) || { "é›»ä¸€ä¹™": Array.from({length:7},()=>Array(5).fill("æœªè¨­å®š")) };
    let notes = JSON.parse(localStorage.getItem('edu_notes')) || {};
    let offset = parseFloat(localStorage.getItem('edu_offset')) || 0;
    let curClass = localStorage.getItem('edu_class') || Object.keys(db)[0];
    let focusedDate = "";
    const noSleep = new NoSleep();

    function init() {
        renderClassList(); renderTable();
        document.getElementById('jsonDB').value = JSON.stringify(db, null, 2);
        setInterval(tick, 1000);
        tick();
    }

    // è¢å¹•é•·äº®é‚è¼¯
    function toggleWakeLock(enabled) {
        if (enabled) {
            noSleep.enable();
            alert("è¢å¹•é•·äº®å·²é–‹å•Ÿ (è«‹ä¿æŒæ­¤é é¢åœ¨å‰æ™¯)");
        } else {
            noSleep.disable();
            alert("è¢å¹•é•·äº®å·²é—œé–‰");
        }
    }

    function tick() {
        const now = new Date();
        const adj = new Date(now.getTime() + offset * 1000);
        const day = adj.getDay();
        const dateKey = adj.toISOString().split('T')[0];
        const sec = adj.getHours() * 3600 + adj.getMinutes() * 60 + adj.getSeconds();

        document.getElementById('full-date').innerText = adj.toLocaleDateString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit'}).replace(/\//g,' / ');
        document.getElementById('real-time').innerText = adj.toTimeString().split(' ')[0];

        const isHoliday = (day === 0 || day === 6 || (notes[dateKey] && notes[dateKey].includes("/æ”¾å‡")));
        document.getElementById('holiday-banner').style.display = isHoliday ? "block" : "none";
        document.getElementById('main-content').style.display = isHoliday ? "none" : "block";

        if (!isHoliday) {
            let curP = -1, cd = 0;
            slots.forEach((s, i) => {
                const start = toSec(s.s), end = toSec(s.e);
                if (sec >= start && sec < end) { curP = i; cd = end - sec; }
                else if (sec < start && curP === -1) { cd = start - sec; }
            });

            const badge = document.getElementById('period-label');
            const sub = document.getElementById('cur-subject');
            const tea = document.getElementById('cur-teacher');

            if (curP !== -1) {
                badge.innerText = `ç¬¬ ${curP + 1} ç¯€ä¸­`;
                const info = db[curClass][curP][day-1].split('(');
                sub.innerText = info[0];
                tea.innerText = info[1] ? info[1].replace(')', '') : "ç„¡æ•™å¸«è³‡è¨Š";
            } else {
                badge.innerText = "ä¼‘æ¯æ™‚é–“"; sub.innerText = "ä¸‹èª²ä¸­"; tea.innerText = "æº–å‚™ä¸‹ä¸€ç¯€";
            }
            document.getElementById('countdown').innerText = formatHMS(cd);
            
            // è¡¨æ ¼äº®é»
            document.querySelectorAll('td').forEach(c => c.classList.remove('active-cell'));
            if (curP !== -1) {
                const row = document.querySelectorAll('tr')[curP + (curP>=4?2:1)];
                if(row) row.cells[day].classList.add('active-cell');
            }
        }
    }

    // æ•™å¸«æœå°‹
    function handleSearch() {
        const q = document.getElementById('tSearch').value.trim();
        const res = document.getElementById('searchInfo');
        if(!q) return res.innerText = "è¼¸å…¥åç¨±æŸ¥è©¢ä½ç½®";
        const adj = new Date(Date.now() + offset * 1000);
        const day = adj.getDay();
        const sec = adj.getHours() * 3600 + adj.getMinutes() * 60;
        let curP = -1;
        slots.forEach((s, i) => { if (sec >= toSec(s.s) && sec < toSec(s.e)) curP = i; });

        let found = "ç›®å‰æ‰¾ä¸åˆ°è©²è€å¸«";
        Object.keys(db).forEach(cls => {
            if(day >= 1 && day <= 5 && curP !== -1) {
                if(db[cls][curP][day-1].includes(q)) found = `ğŸ“ ç›®å‰ä½ç½®ï¼š${cls}`;
            }
        });
        res.innerText = `ğŸ‘¨â€ğŸ« è€å¸«ï¼š${q}\n${found}`;
    }

    // å½ˆçª—èˆ‡è¡Œäº‹æ›†æ§åˆ¶
    function toggleModal(id) {
        const m = document.getElementById(id);
        m.style.display = (m.style.display === 'block') ? 'none' : 'block';
    }

    function openCalendar() {
        toggleModal('menuModal');
        toggleModal('calModal');
        renderCalendar();
    }

    function closeCalendar() {
        toggleModal('calModal');
        toggleModal('menuModal');
    }

    function renderCalendar() {
        const d = new Date();
        const y = d.getFullYear(), m = d.getMonth();
        document.getElementById('calMonthTitle').innerText = `${y} / ${String(m+1).padStart(2,'0')}`;
        const total = new Date(y, m + 1, 0).getDate();
        let h = "";
        for(let i=1; i<=total; i++) {
            const dk = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            h += `<div class="cal-day ${notes[dk]?'note-mark':''}" onclick="showNote('${dk}')">${i}</div>`;
        }
        document.getElementById('calendarGrid').innerHTML = h;
    }

    function showNote(dk) {
        focusedDate = dk;
        document.getElementById('notePanel').style.display = "block";
        document.getElementById('selDateDisplay').innerText = dk;
        document.getElementById('dateNote').value = notes[dk] || "";
    }

    function saveNote() {
        notes[focusedDate] = document.getElementById('dateNote').value;
        localStorage.setItem('edu_notes', JSON.stringify(notes));
        renderCalendar();
        alert("å„²å­˜æˆåŠŸ");
    }

    function toSec(t) { const [h, m] = t.split(':'); return h*3600 + m*60; }
    function formatHMS(s) { return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; }
    function renderClassList() { document.getElementById('classSelector').innerHTML = Object.keys(db).map(c => `<option value="${c}" ${c===curClass?'selected':''}>${c}</option>`).join(''); }
    function switchClass() { curClass = document.getElementById('classSelector').value; localStorage.setItem('edu_class', curClass); renderTable(); }
    function saveDB() { try { db = JSON.parse(document.getElementById('jsonDB').value); localStorage.setItem('edu_db', JSON.stringify(db)); renderClassList(); renderTable(); alert("å„²å­˜æˆåŠŸ"); } catch(e) { alert("JSON æ ¼å¼éŒ¯èª¤"); } }
    
    function renderTable() {
        const data = db[curClass];
        let h = `<table><tr><th>ç¯€</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th></tr>`;
        data.forEach((row, i) => {
            if(i===4) h += `<tr style="color:#444;"><td colspan="6">åˆä¼‘</td></tr>`;
            h += `<tr><td>${i+1}</td>` + row.map(c => `<td>${c.split('(')[0]}</td>`).join('') + `</tr>`;
        });
        document.getElementById('tableBox').innerHTML = h + `</table>`;
    }

    window.onload = init;
</script>
</body>
</html>
