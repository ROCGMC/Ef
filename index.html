<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»ä¸€ä¹™ å‹•æ…‹èª²è¡¨ V3</title>
    <style>
        :root { --primary: #2196F3; --accent: #FFEB3B; --bg: #f5f7fa; --dark: #2c3e50; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; }
        
        /* å„€è¡¨æ¿ */
        .dashboard { background: var(--dark); color: white; padding: 25px 15px; border-radius: 20px; text-align: center; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); position: relative; }
        #countdown { font-size: 4rem; font-weight: bold; color: var(--accent); margin: 5px 0; font-family: monospace; }
        #status-text { font-size: 1.1rem; opacity: 0.9; }
        
        /* å³ä¸Šè§’é¸å–® */
        .menu-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: white; }

        /* è¡¨æ ¼æ¨£å¼ */
        .table-card { background: white; border-radius: 15px; overflow-x: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 450px; }
        th, td { border: 1px solid #eee; padding: 12px 5px; text-align: center; font-size: 14px; transition: 0.3s; }
        th { background: #34495e; color: white; }
        .active-cell { background-color: var(--accent) !important; font-weight: bold; color: #000; box-shadow: inset 0 0 5px rgba(0,0,0,0.2); }
        .teacher { font-size: 11px; color: #888; display: block; }
        
        /* å½ˆçª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; }
        .modal-body { background: white; margin: 30px auto; padding: 20px; width: 85%; max-width: 400px; border-radius: 20px; color: #333; }
        .modal-body h3 { margin-top: 0; }
        input[type="text"] { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        
        /* ç·¨è¼¯ä¸­ç‹€æ…‹ */
        [contenteditable="true"] { background: #fffde7; outline: 2px solid var(--primary); }
        .btn-group { display: flex; gap: 5px; justify-content: center; margin-top: 10px; }
        button { padding: 10px 15px; border-radius: 8px; border: none; cursor: pointer; }
        .btn-save { background: #4caf50; color: white; }
        .btn-cancel { background: #f44336; color: white; }
    </style>
</head>
<body>

<div class="dashboard">
    <button class="menu-btn" onclick="toggleModal('menuModal')">âš™ï¸</button>
    <div id="status-text">è¼‰å…¥ä¸­...</div>
    <div id="countdown">00:00</div>
    <div style="font-size: 12px; color: #95a5a6;">
        æ ¡å°: <span id="offLab">0</span>s | <span id="realClock">00:00:00</span>
    </div>
    <div class="btn-group">
        <button onclick="adjTime(-1)" style="padding:4px 8px; font-size:11px;">-1s</button>
        <button onclick="adjTime(1)" style="padding:4px 8px; font-size:11px;">+1s</button>
    </div>
</div>

<div class="table-card" id="tableBox"></div>

<div id="menuModal" class="modal">
    <div class="modal-body">
        <h3>ç³»çµ±åŠŸèƒ½</h3>
        <label><input type="checkbox" id="wakeLockCheck" onchange="toggleWake(this.checked)"> è¢å¹•é•·äº® (Wake Lock)</label>
        <hr>
        <h4>ğŸ” æ‰¾è€å¸« (æœå°‹å‹•æ…‹)</h4>
        <input type="text" id="tQuery" placeholder="è¼¸å…¥è€å¸«å§“å..." oninput="searchT()">
        <div id="searchRes" style="color:var(--primary); font-weight:bold; min-height:20px;"></div>
        <hr>
        <h4>ğŸ› ï¸ èª²è¡¨ç·¨è¼¯</h4>
        <button id="editBtn" onclick="enterEdit()" style="width:100%; background:var(--dark); color:white;">âœï¸ é€²å…¥ç·¨è¼¯æ¨¡å¼</button>
        <div id="editControls" style="display:none;" class="btn-group">
            <button class="btn-save" onclick="saveData()">ğŸ’¾ å„²å­˜ä¸¦æ›´æ–°</button>
            <button class="btn-cancel" onclick="exitEdit()">å–æ¶ˆ</button>
        </div>
        <br>
        <button onclick="toggleModal('menuModal')" style="width:100%; margin-top:10px;">é—œé–‰é¸å–®</button>
    </div>
</div>

<script>
    // é è¨­èª²è¡¨è³‡æ–™ (JSON)
    const defaultData = [
        ["å…¨æ°‘åœ‹é˜²(é™³æ€¡ä»Š)", "åœ‹èªæ–‡(é™³ç¾åµ)", "ç©æœ¨ç¨‹å¼(è¬ç§€å®)", "å¥åº·è­·ç†(ææ€¡è“‰)", "åŸºæœ¬é›»å­¸(æ¥Šæ£®è©•)"],
        ["éŸ³æ¨‚(é˜æ‚…ç¶¾)", "åœ‹èªæ–‡(é™³ç¾åµ)", "ç©æœ¨ç¨‹å¼(è¬ç§€å®)", "é–©å—èªæ–‡(é™³æ€¡ä»Š)", "åŸºæœ¬é›»å­¸(æ¥Šæ£®è©•)"],
        ["æ‡‰ç”¨è‹±æ–‡(å¼µç¬ç¾)", "è‹±èªæ–‡(å¼µç¬ç¾)", "ç©æœ¨ç¨‹å¼(è¬ç§€å®)", "ç”Ÿæ´»ç§‘æŠ€(æ¥Šæ£®è©•)", "ç‰©ç†(é¾”æ¦®å¿—)"],
        ["æ•¸å­¸(æ´ªå¤è°)", "æ•¸å­¸(æ´ªå¤è°)", "æ­·å²(é™³è±”é¡)", "ç”Ÿæ´»ç§‘æŠ€(æ¥Šæ£®è©•)", "æ­·å²(é™³è±”é¡)"],
        ["åŸºé›»å¯¦ç¿’(æå† ç« )", "ç‰©ç†(é¾”æ¦®å¿—)", "é€±æœƒ/è¯èª²", "åœ‹èªæ–‡(é™³ç¾åµ)", "è‹±èªæ–‡(å¼µç¬ç¾)"],
        ["åŸºé›»å¯¦ç¿’(æå† ç« )", "é«”è‚²(å¼µæƒ ç)", "é€±æœƒ/è¯èª²", "è—è¡“ç”Ÿæ´»(è‘£æ€¡èŠ³)", "æ•¸å­¸(æ´ªå¤è°)"],
        ["åŸºé›»å¯¦ç¿’(æå† ç« )", "åŸºæœ¬é›»å­¸(æ¥Šæ£®è©•)", "ç­æœƒ(æ´ªå¤è°)", "æ•¸å­¸(æ´ªå¤è°)", "é«”è‚²(å¼µæƒ ç)"]
    ];

    const slots = [
        { s: "08:10", e: "09:00" }, { s: "09:10", e: "10:00" },
        { s: "10:10", e: "11:00" }, { s: "11:10", e: "12:00" },
        { s: "13:10", e: "14:00" }, { s: "14:10", e: "15:00" },
        { s: "15:20", e: "16:10" }
    ];

    let myData = JSON.parse(localStorage.getItem('user_schedule')) || defaultData;
    let timeOffset = parseInt(localStorage.getItem('time_offset')) || 0;
    let wakeLock = null;

    function init() {
        renderTable();
        setInterval(tick, 1000);
    }

    function renderTable() {
        let h = `<table><tr><th>ç¯€</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th></tr>`;
        myData.forEach((row, pIdx) => {
            if (pIdx === 4) h += `<tr style="background:#f9f9f9;font-size:12px;color:#999"><td colspan="6">åˆä¼‘ 12:00 - 13:10</td></tr>`;
            h += `<tr><td>${pIdx + 1}</td>`;
            row.forEach((cell, dIdx) => {
                let [sub, tea] = cell.split('(');
                h += `<td class="s-cell" data-p="${pIdx}" data-d="${dIdx}">${sub}${tea ? `<span class="teacher">(${tea}</span>` : ""}</td>`;
            });
            h += `</tr>`;
        });
        document.getElementById('tableBox').innerHTML = h + `</table>`;
    }

    function tick() {
        const now = new Date(Date.now() + timeOffset * 1000);
        const sec = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
        const day = now.getDay();
        document.getElementById('realClock').innerText = now.toTimeString().split(' ')[0];
        document.getElementById('offLab').innerText = timeOffset;

        let cur = -1, cd = "--:--", st = "æ”¾å­¸/ä¼‘æ¯ä¸­";
        slots.forEach((o, i) => {
            const startS = toSec(o.s), endS = toSec(o.e);
            if (sec >= startS && sec < endS) {
                cur = i; st = `æ­£åœ¨ä¸Šï¼šç¬¬ ${i + 1} ç¯€`;
                let r = endS - sec; cd = `${Math.floor(r / 60)}:${String(r % 60).padStart(2, '0')}`;
            } else if (sec < startS && cd === "--:--") {
                let w = startS - sec; st = `è·é›¢ä¸‹ä¸€ç¯€èª²`;
                cd = `${Math.floor(w / 60)}:${String(w % 60).padStart(2, '0')}`;
            }
        });

        document.getElementById('countdown').innerText = cd;
        document.getElementById('status-text').innerText = st;

        document.querySelectorAll('td').forEach(c => c.classList.remove('active-cell'));
        if (cur !== -1 && day >= 1 && day <= 5) {
            const rowIdx = cur + (cur >= 4 ? 2 : 1);
            const targetRow = document.querySelectorAll('tr')[rowIdx];
            if (targetRow) targetRow.cells[day].classList.add('active-cell');
        }
    }

    // ç·¨è¼¯é‚è¼¯
    function enterEdit() {
        document.querySelectorAll('.s-cell').forEach(c => c.contentEditable = "true");
        document.getElementById('editBtn').style.display = 'none';
        document.getElementById('editControls').style.display = 'flex';
        toggleModal('menuModal'); // æš«æ™‚é—œé–‰é¸å–®è®“ç”¨æˆ¶ç·¨è¼¯è¡¨æ ¼
    }

    function saveData() {
        const newData = Array.from({ length: 7 }, () => Array(5).fill(""));
        document.querySelectorAll('.s-cell').forEach(c => {
            newData[c.dataset.p][c.dataset.d] = c.innerText.trim();
        });
        myData = newData;
        localStorage.setItem('user_schedule', JSON.stringify(newData));
        exitEdit();
        renderTable();
        alert("èª²è¡¨å·²å„²å­˜ï¼");
    }

    function exitEdit() {
        document.querySelectorAll('.s-cell').forEach(c => c.contentEditable = "false");
        document.getElementById('editBtn').style.display = 'block';
        document.getElementById('editControls').style.display = 'none';
    }

    // æ‰¾è€å¸«é‚è¼¯
    function searchT() {
        const q = document.getElementById('tQuery').value;
        if (!q) return document.getElementById('searchRes').innerText = "";
        const now = new Date(Date.now() + timeOffset * 1000);
        const day = now.getDay();
        let found = "æ­¤æ™‚æ®µæ²’èª²";
        
        // æœå°‹ç›®å‰ç¯€æ¬¡
        const sec = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
        let curP = -1;
        slots.forEach((o, i) => { if(sec >= toSec(o.s) && sec < toSec(o.e)) curP = i; });

        if(curP !== -1 && day >= 1 && day <= 5) {
            if(myData[curP][day-1].includes(q)) found = `ğŸ“ æ­£åœ¨æœ¬ç­ä¸Šèª²`;
            else found = `ğŸ” æœå°‹ä¸­... (æ­¤åŠŸèƒ½éœ€æƒæå…¨æ ¡è³‡æ–™)`;
        }
        document.getElementById('searchRes').innerText = found;
    }

    // å·¥å…·
    async function toggleWake(on) {
        if(on) { try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e){} }
        else if(wakeLock) { wakeLock.release(); wakeLock=null; }
    }
    function toSec(t) { const [h, m] = t.split(':'); return h * 3600 + m * 60; }
    function adjTime(v) { timeOffset += v; localStorage.setItem('time_offset', timeOffset); }
    function toggleModal(id) { const m = document.getElementById(id); m.style.display = (m.style.display==='block'?'none':'block'); }
    
    window.onload = init;
</script>
</body>
</html>
