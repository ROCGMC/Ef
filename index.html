<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨åŠŸèƒ½ æ•¸ä½èª²è¡¨ç³»çµ±</title>
    <link href="https://fonts.cdnfonts.com/css/digital-7-mono" rel="stylesheet">
    <style>
        :root { --primary: #2196F3; --accent: #00ff41; --bg: #0a0a0a; --card: #1a1a1a; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #eee; }
        
        /* å„€è¡¨æ¿ */
        .dashboard { background: #000; color: white; padding: 25px 15px; border-radius: 20px; text-align: center; margin-bottom: 15px; border: 2px solid #333; position: relative; }
        
        /* 7 æ®µé¡¯ç¤ºå™¨é¢¨æ ¼ */
        #countdown { 
            font-family: 'Digital-7 Mono', sans-serif; 
            font-size: 5rem; 
            color: var(--accent); 
            text-shadow: 0 0 20px rgba(0, 255, 65, 0.5);
            margin: 10px 0;
            line-height: 1;
        }
        
        #status-text { font-size: 1.1rem; color: #aaa; letter-spacing: 1px; }

        /* ä¸‰æ¢ç·šé¸å–®æŒ‰éˆ• */
        .menu-btn { 
            position: absolute; top: 20px; right: 20px; background: none; border: none; 
            cursor: pointer; padding: 5px; z-index: 10;
        }
        .menu-btn div { width: 30px; height: 3px; background-color: white; margin: 6px 0; transition: 0.4s; }

        /* è¡¨æ ¼æ¨£å¼ */
        .table-card { background: var(--card); border-radius: 15px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 450px; }
        th, td { border: 1px solid #333; padding: 12px 5px; text-align: center; font-size: 14px; }
        th { background: #222; color: #888; }
        .active-cell { background-color: rgba(0, 255, 65, 0.2) !important; color: var(--accent); font-weight: bold; }
        
        /* å½ˆçª—èˆ‡è¼¸å…¥ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; overflow-y: auto; }
        .modal-body { background: #222; margin: 20px auto; padding: 25px; width: 90%; max-width: 500px; border-radius: 20px; border: 1px solid #444; }
        textarea { width: 100%; height: 150px; background: #000; color: #0f0; border: 1px solid #444; padding: 10px; font-family: monospace; }
        input[type="text"] { width: 100%; padding: 12px; background: #333; border: none; color: white; border-radius: 8px; margin: 10px 0; box-sizing: border-box;}
        
        button { padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; margin: 5px 0; }
        .btn-save { background: var(--primary); color: white; width: 100%; }
        .btn-close { background: #444; color: white; width: 100%; }
    </style>
</head>
<body>

<div class="dashboard">
    <button class="menu-btn" onclick="toggleModal('menuModal')">
        <div></div><div></div><div></div>
    </button>
    <div id="status-text">SYSTEM READY</div>
    <div id="countdown">00:00:00</div>
    <div style="font-size: 11px; color: #555;">OFFSET: <span id="offLab">0</span>s</div>
</div>

<select id="classSelector" onchange="switchClass()" style="width:100%; padding:12px; background:#1a1a1a; color:white; border:1px solid #333; border-radius:10px; margin-bottom:15px;"></select>

<div class="table-card" id="tableBox"></div>

<div id="menuModal" class="modal">
    <div class="modal-body">
        <h3 style="color:var(--primary)">MENU</h3>
        <label><input type="checkbox" id="wakeLockCheck" onchange="toggleWake(this.checked)"> Keep Screen On</label>
        
        <hr style="border-color:#333">
        <h4>ğŸ” è€å¸«å‹•æ…‹è¿½è¹¤</h4>
        <input type="text" id="tQuery" placeholder="è¼¸å…¥è€å¸«å§“å (ä¾‹å¦‚ï¼šé™³æ€¡ä»Š)..." oninput="searchT()">
        <div id="searchRes" style="background:#000; padding:15px; border-radius:10px; min-height:50px; font-size:14px; line-height:1.6;"></div>

        <hr style="border-color:#333">
        <h4>ğŸ› ï¸ DataJS æ ¸å¿ƒç·¨è¼¯</h4>
        <textarea id="jsonInput"></textarea>
        <button class="btn-save" onclick="importJSON()">å„²å­˜ä¸¦åŸ·è¡Œä»£ç¢¼</button>
        <button class="btn-close" onclick="toggleModal('menuModal')">é—œé–‰</button>
    </div>
</div>

<script>
    const defaultDB = {
        "é›»ä¸€ä¹™": [
            ["å…¨æ°‘åœ‹é˜²(é™³æ€¡ä»Š)", "åœ‹èªæ–‡(é™³ç¾åµ)", "ç©æœ¨ç¨‹å¼(è¬ç§€å®)", "å¥åº·è­·ç†(ææ€¡è“‰)", "åŸºæœ¬é›»å­¸(æ¥Šæ£®è©•)"],
            ["éŸ³æ¨‚(é˜æ‚…ç¶¾)", "åœ‹èªæ–‡(é™³ç¾åµ)", "ç©æœ¨ç¨‹å¼(è¬ç§€å®)", "é–©å—èªæ–‡(é™³æ€¡ä»Š)", "åŸºæœ¬é›»å­¸(æ¥Šæ£®è©•)"],
            ["æ‡‰ç”¨è‹±æ–‡(å¼µç¬ç¾)", "è‹±èªæ–‡(å¼µç¬ç¾)", "ç©æœ¨ç¨‹å¼(è¬ç§€å®)", "ç”Ÿæ´»ç§‘æŠ€(æ¥Šæ£®è©•)", "ç‰©ç†(é¾”æ¦®å¿—)"],
            ["æ•¸å­¸(æ´ªå¤è°)", "æ•¸å­¸(æ´ªå¤è°)", "æ­·å²(é™³è±”é¡)", "ç”Ÿæ´»ç§‘æŠ€(æ¥Šæ£®è©•)", "æ­·å²(é™³è±”é¡)"],
            ["åŸºé›»å¯¦ç¿’(æå† ç« )", "ç‰©ç†(é¾”æ¦®å¿—)", "é€±æœƒ/è¯èª²", "åœ‹èªæ–‡(é™³ç¾åµ)", "è‹±èªæ–‡(å¼µç¬ç¾)"],
            ["åŸºé›»å¯¦ç¿’(æå† ç« )", "é«”è‚²(å¼µæƒ ç)", "é€±æœƒ/è¯èª²", "è—è¡“ç”Ÿæ´»(è‘£æ€¡èŠ³)", "æ•¸å­¸(æ´ªå¤è°)"],
            ["åŸºé›»å¯¦ç¿’(æå† ç« )", "åŸºæœ¬é›»å­¸(æ¥Šæ£®è©•)", "ç­æœƒ(æ´ªå¤è°)", "æ•¸å­¸(æ´ªå¤è°)", "é«”è‚²(å¼µæƒ ç)"]
        ]
    };

    const slots = [
        { s: "08:10", e: "09:00" }, { s: "09:10", e: "10:00" }, { s: "10:10", e: "11:00" },
        { s: "11:10", e: "12:00" }, { s: "13:10", e: "14:00" }, { s: "14:10", e: "15:00" },
        { s: "15:20", e: "16:10" }
    ];

    let fullDB = JSON.parse(localStorage.getItem('full_database')) || defaultDB;
    let currentClass = localStorage.getItem('current_class') || Object.keys(fullDB)[0];
    let timeOffset = parseInt(localStorage.getItem('time_offset')) || 0;
    let wakeLock = null;

    function init() {
        updateSelector();
        renderTable();
        setInterval(tick, 1000);
        document.getElementById('jsonInput').value = JSON.stringify(fullDB, null, 2);
    }

    // æ ¼å¼åŒ–æ™‚é–“ï¼šè‡ªå‹•é€²ä½å°æ™‚
    function formatTime(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;
        if (h > 0) {
            return `${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }
        return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    function tick() {
        const now = new Date(Date.now() + timeOffset * 1000);
        const sec = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
        const day = now.getDay();
        document.getElementById('offLab').innerText = timeOffset;

        let curP = -1, cdVal = 0, st = "IDLE / æ”¾å­¸";
        slots.forEach((o, i) => {
            const startS = toSec(o.s), endS = toSec(o.e);
            if (sec >= startS && sec < endS) {
                curP = i; st = `PERIOD ${i + 1} ACTIVE`;
                cdVal = endS - sec;
            } else if (sec < startS && cdVal === 0) {
                st = `NEXT PERIOD STARTING`;
                cdVal = startS - sec;
            }
        });

        document.getElementById('countdown').innerText = formatTime(cdVal);
        document.getElementById('status-text').innerText = st;

        document.querySelectorAll('td').forEach(c => c.classList.remove('active-cell'));
        if (curP !== -1 && day >= 1 && day <= 5) {
            const rowIdx = curP + (curP >= 4 ? 2 : 1);
            const targetRow = document.querySelectorAll('tr')[rowIdx];
            if (targetRow) targetRow.cells[day].classList.add('active-cell');
        }
    }

    // æœå°‹æ•™å¸«é‚è¼¯ (åŒ…å«ä¸‹ä¸€ç¯€ä½ç½®)
    function searchT() {
        const q = document.getElementById('tQuery').value.trim();
        const resBox = document.getElementById('searchRes');
        if (!q) { resBox.innerHTML = ""; return; }
        
        const now = new Date(Date.now() + timeOffset * 1000);
        const day = now.getDay();
        const sec = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
        
        let curP = -1;
        slots.forEach((o, i) => { if(sec >= toSec(o.s) && sec < toSec(o.e)) curP = i; });

        let currentPos = "ä¼‘æ¯ä¸­", nextPos = "ç„¡èª²ç¨‹";

        Object.keys(fullDB).forEach(cls => {
            if (day >= 1 && day <= 5) {
                // ç•¶å‰ä½ç½®
                if (curP !== -1 && fullDB[cls][curP][day-1].includes(q)) currentPos = `ğŸ“ æ­£åœ¨ <b>${cls}</b> ä¸Šèª²`;
                // ä¸‹ä¸€ç¯€ä½ç½®
                if (curP < 6 && fullDB[cls][curP+1][day-1].includes(q)) nextPos = `<b>${cls}</b>`;
            }
        });

        resBox.innerHTML = `
            <div style="color:var(--accent)">${q} è€å¸«</div>
            <div style="margin-top:5px;">${currentPos}</div>
            <div style="font-size:12px; color:#888;">â­ï¸ ä¸‹ä¸€ç¯€ä½ç½®ï¼š${nextPos}</div>
        `;
    }

    function updateSelector() {
        const sel = document.getElementById('classSelector');
        sel.innerHTML = Object.keys(fullDB).map(cls => `<option value="${cls}" ${cls === currentClass ? 'selected' : ''}>${cls}</option>`).join('');
    }

    function renderTable() {
        if(!fullDB[currentClass]) currentClass = Object.keys(fullDB)[0];
        let data = fullDB[currentClass];
        let h = `<table><tr><th>ç¯€</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th></tr>`;
        data.forEach((row, pIdx) => {
            if (pIdx === 4) h += `<tr style="background:#111; font-size:12px; color:#444"><td colspan="6">LUNCH BREAK</td></tr>`;
            h += `<tr><td>${pIdx + 1}</td>`;
            row.forEach((cell) => {
                let [sub, tea] = cell.split('(');
                h += `<td>${sub}${tea ? `<span class="teacher">(${tea}</span>` : ""}</td>`;
            });
            h += `</tr>`;
        });
        document.getElementById('tableBox').innerHTML = h + `</table>`;
    }

    function importJSON() {
        try {
            const newDB = JSON.parse(document.getElementById('jsonInput').value);
            fullDB = newDB;
            localStorage.setItem('full_database', JSON.stringify(fullDB));
            updateSelector();
            switchClass();
            alert("SUCCESS: è³‡æ–™åº«å·²åŒæ­¥");
        } catch (e) { alert("ERROR: JSON èªæ³•éŒ¯èª¤"); }
    }

    function switchClass() {
        currentClass = document.getElementById('classSelector').value;
        localStorage.setItem('current_class', currentClass);
        renderTable();
    }
    function toSec(t) { const [h, m] = t.split(':'); return h * 3600 + m * 60; }
    function toggleModal(id) { document.getElementById(id).style.display = (document.getElementById(id).style.display==='block'?'none':'block'); }
    async function toggleWake(on) { if(on) wakeLock = await navigator.wakeLock.request('screen'); else if(wakeLock) wakeLock.release(); }
    window.onload = init;
</script>
</body>
</html>
