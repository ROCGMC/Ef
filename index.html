<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨åŠŸèƒ½ é›²ç«¯èª²è¡¨ç³»çµ±</title>
    <style>
        :root { --primary: #2196F3; --accent: #FFEB3B; --bg: #f5f7fa; --dark: #2c3e50; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; }
        
        /* å„€è¡¨æ¿ */
        .dashboard { background: var(--dark); color: white; padding: 20px 15px; border-radius: 20px; text-align: center; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); position: relative; }
        #countdown { font-size: 3.5rem; font-weight: bold; color: var(--accent); margin: 5px 0; font-family: monospace; }
        #status-text { font-size: 1.1rem; opacity: 0.9; }
        
        /* ä»‹é¢æŒ‰éˆ•èˆ‡é¸å–® */
        .menu-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: white; }
        select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 15px; font-size: 16px; background: white; }

        /* è¡¨æ ¼æ¨£å¼ */
        .table-card { background: white; border-radius: 15px; overflow-x: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 450px; }
        th, td { border: 1px solid #eee; padding: 10px 5px; text-align: center; font-size: 14px; }
        th { background: #34495e; color: white; }
        .active-cell { background-color: var(--accent) !important; font-weight: bold; color: #000; }
        .teacher { font-size: 11px; color: #888; display: block; }
        
        /* å½ˆçª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; overflow-y: auto; }
        .modal-body { background: white; margin: 20px auto; padding: 20px; width: 90%; max-width: 500px; border-radius: 20px; color: #333; }
        textarea { width: 100%; height: 200px; font-family: monospace; font-size: 12px; padding: 10px; box-sizing: border-box; border-radius: 10px; border: 1px solid #ccc; }
        
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
        button { flex: 1; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        .btn-main { background: var(--primary); color: white; }
        .btn-save { background: #4caf50; color: white; }
        .btn-close { background: #eee; color: #333; width: 100%; margin-top: 10px; }
    </style>
</head>
<body>

<div class="dashboard">
    <button class="menu-btn" onclick="toggleModal('menuModal')">âš™ï¸</button>
    <div id="status-text">è¼‰å…¥ä¸­...</div>
    <div id="countdown">00:00</div>
    <div style="font-size: 12px; color: #95a5a6;">æ ¡å°: <span id="offLab">0</span>s</div>
</div>

<select id="classSelector" onchange="switchClass()"></select>

<div class="table-card" id="tableBox"></div>

<div id="menuModal" class="modal">
    <div class="modal-body">
        <h3>âš™ï¸ ç³»çµ±è¨­å®š</h3>
        <label><input type="checkbox" id="wakeLockCheck" onchange="toggleWake(this.checked)"> è¢å¹•é•·äº®æ¨¡å¼</label>
        
        <hr>
        <h4>ğŸ” æ•™å¸«è¿½è¹¤ (å…¨æ ¡æƒæ)</h4>
        <input type="text" id="tQuery" placeholder="è¼¸å…¥è€å¸«å§“å..." oninput="searchT()" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; box-sizing:border-box;">
        <div id="searchRes" style="color:var(--primary); font-weight:bold; margin-top:10px; min-height:20px;"></div>

        <hr>
        <h4>ğŸ› ï¸ DataJS è³‡æ–™åº«ç·¨è¼¯ (JSON)</h4>
        <p style="font-size: 12px; color: #666;">è«‹åœ¨æ­¤è²¼ä¸Šå®Œæ•´çš„èª²è¡¨ JSON ä»£ç¢¼ï¼š</p>
        <textarea id="jsonInput"></textarea>
        <div class="btn-group">
            <button class="btn-save" onclick="importJSON()">ğŸ’¾ å„²å­˜ä¸¦å¥—ç”¨è³‡æ–™åº«</button>
            <button class="btn-main" onclick="exportJSON()">å°å‡ºç›®å‰å‚™ä»½</button>
        </div>

        <button class="btn-close" onclick="toggleModal('menuModal')">é—œé–‰</button>
    </div>
</div>

<script>
    // é è¨­ç¯„ä¾‹è³‡æ–™ (ç•¶æœ¬åœ°æ²’è³‡æ–™æ™‚é¡¯ç¤º)
    const defaultDB = {
        "é›»ä¸€ä¹™": [
            ["å…¨æ°‘åœ‹é˜²(é™³æ€¡ä»Š)", "åœ‹èªæ–‡(é™³ç¾åµ)", "ç©æœ¨ç¨‹å¼(è¬ç§€å®)", "å¥åº·è­·ç†(ææ€¡è“‰)", "åŸºæœ¬é›»å­¸(æ¥Šæ£®è©•)"],
            ["éŸ³æ¨‚(é˜æ‚…ç¶¾)", "åœ‹èªæ–‡(é™³ç¾åµ)", "ç©æœ¨ç¨‹å¼(è¬ç§€å®)", "é–©å—èªæ–‡(é™³æ€¡ä»Š)", "åŸºæœ¬é›»å­¸(æ¥Šæ£®è©•)"],
            ["æ‡‰ç”¨è‹±æ–‡(å¼µç¬ç¾)", "è‹±èªæ–‡(å¼µç¬ç¾)", "ç©æœ¨ç¨‹å¼(è¬ç§€å®)", "ç”Ÿæ´»ç§‘æŠ€(æ¥Šæ£®è©•)", "ç‰©ç†(é¾”æ¦®å¿—)"],
            ["æ•¸å­¸(æ´ªå¤è°)", "æ•¸å­¸(æ´ªå¤è°)", "æ­·å²(é™³è±”é¡)", "ç”Ÿæ´»ç§‘æŠ€(æ¥Šæ£®è©•)", "æ­·å²(é™³è±”é¡)"],
            ["åŸºé›»å¯¦ç¿’(æå† ç« )", "ç‰©ç†(é¾”æ¦®å¿—)", "é€±æœƒ/è¯èª²", "åœ‹èªæ–‡(é™³ç¾åµ)", "è‹±èªæ–‡(å¼µç¬ç¾)"],
            ["åŸºé›»å¯¦ç¿’(æå† ç« )", "é«”è‚²(å¼µæƒ ç)", "é€±æœƒ/è¯èª²", "è—è¡“ç”Ÿæ´»(è‘£æ€¡èŠ³)", "æ•¸å­¸(æ´ªå¤è°)"],
            ["åŸºé›»å¯¦ç¿’(æå† ç« )", "åŸºæœ¬é›»å­¸(æ¥Šæ£®è©•)", "ç­æœƒ(æ´ªå¤è°)", "æ•¸å­¸(æ´ªå¤è°)", "é«”è‚²(å¼µæƒ ç)"]
        ]
    };

    const slots = [
        { s: "08:10", e: "09:00" }, { s: "09:10", e: "10:00" }, { s: "10:10", e: "11:00" },
        { s: "11:10", e: "12:00" }, { s: "13:10", e: "14:00" }, { s: "14:10", e: "15:00" },
        { s: "15:20", e: "16:10" }
    ];

    let fullDB = JSON.parse(localStorage.getItem('full_database')) || defaultDB;
    let currentClass = localStorage.getItem('current_class') || Object.keys(fullDB)[0];
    let timeOffset = parseInt(localStorage.getItem('time_offset')) || 0;
    let wakeLock = null;

    function init() {
        updateSelector();
        renderTable();
        setInterval(tick, 1000);
        document.getElementById('jsonInput').value = JSON.stringify(fullDB, null, 2);
    }

    // æ›´æ–°ä¸‹æ‹‰é¸å–®
    function updateSelector() {
        const sel = document.getElementById('classSelector');
        sel.innerHTML = Object.keys(fullDB).map(cls => `<option value="${cls}" ${cls === currentClass ? 'selected' : ''}>${cls}</option>`).join('');
    }

    function renderTable() {
        if(!fullDB[currentClass]) currentClass = Object.keys(fullDB)[0];
        let data = fullDB[currentClass];
        let h = `<table><tr><th>ç¯€</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th></tr>`;
        data.forEach((row, pIdx) => {
            if (pIdx === 4) h += `<tr style="background:#f9f9f9;font-size:12px;color:#999"><td colspan="6">åˆä¼‘ 12:00 - 13:10</td></tr>`;
            h += `<tr><td>${pIdx + 1}</td>`;
            row.forEach((cell) => {
                let [sub, tea] = cell.split('(');
                h += `<td>${sub}${tea ? `<span class="teacher">(${tea}</span>` : ""}</td>`;
            });
            h += `</tr>`;
        });
        document.getElementById('tableBox').innerHTML = h + `</table>`;
    }

    function tick() {
        const now = new Date(Date.now() + timeOffset * 1000);
        const sec = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
        const day = now.getDay();
        document.getElementById('offLab').innerText = timeOffset;

        let curP = -1, cd = "--:--", st = "æ”¾å­¸/ä¼‘æ¯ä¸­";
        slots.forEach((o, i) => {
            const startS = toSec(o.s), endS = toSec(o.e);
            if (sec >= startS && sec < endS) {
                curP = i; st = `æ­£åœ¨ä¸Šï¼šç¬¬ ${i + 1} ç¯€`;
                let r = endS - sec; cd = `${Math.floor(r / 60)}:${String(r % 60).padStart(2, '0')}`;
            } else if (sec < startS && cd === "--:--") {
                let w = startS - sec; st = `è·é›¢ä¸‹ä¸€ç¯€`;
                cd = `${Math.floor(w / 60)}:${String(w % 60).padStart(2, '0')}`;
            }
        });

        document.getElementById('countdown').innerText = cd;
        document.getElementById('status-text').innerText = st;

        document.querySelectorAll('td').forEach(c => c.classList.remove('active-cell'));
        if (curP !== -1 && day >= 1 && day <= 5) {
            const rowIdx = curP + (curP >= 4 ? 2 : 1);
            const targetRow = document.querySelectorAll('tr')[rowIdx];
            if (targetRow) targetRow.cells[day].classList.add('active-cell');
        }
    }

    // JSON å„²å­˜èˆ‡åŸ·è¡Œ
    function importJSON() {
        try {
            const input = document.getElementById('jsonInput').value;
            const newDB = JSON.parse(input);
            fullDB = newDB;
            localStorage.setItem('full_database', JSON.stringify(fullDB));
            updateSelector();
            switchClass();
            alert("âœ… è³‡æ–™åº«æ›´æ–°æˆåŠŸï¼");
        } catch (e) {
            alert("âŒ JSON æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¬¦è™Ÿæ˜¯å¦æ­£ç¢ºã€‚");
        }
    }

    function exportJSON() {
        document.getElementById('jsonInput').value = JSON.stringify(fullDB, null, 2);
        alert("å·²å°‡ç›®å‰çš„è³‡æ–™åº«å°å‡ºè‡³æ–‡å­—æ¡†ã€‚");
    }

    // æ‰¾è€å¸« (å…¨è³‡æ–™åº«æœå°‹)
    function searchT() {
        const q = document.getElementById('tQuery').value.trim();
        if (!q) return document.getElementById('searchRes').innerText = "";
        
        const now = new Date(Date.now() + timeOffset * 1000);
        const day = now.getDay();
        const sec = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
        
        let curP = -1;
        slots.forEach((o, i) => { if(sec >= toSec(o.s) && sec < toSec(o.e)) curP = i; });

        if (day < 1 || day > 5) return document.getElementById('searchRes').innerText = "é€±æœ«æ”¾å‡ä¸­";

        let results = [];
        Object.keys(fullDB).forEach(cls => {
            if(curP !== -1 && fullDB[cls][curP][day-1].includes(q)) {
                results.push(`ğŸ“ ç›®å‰åœ¨ï¼š${cls}`);
            }
        });

        document.getElementById('searchRes').innerText = results.length > 0 ? results.join(' | ') : "ğŸ” æ­¤æ™‚æ®µæœªæ‰¾åˆ°è©²ä½è€å¸«";
    }

    // åŠŸèƒ½
    function switchClass() {
        currentClass = document.getElementById('classSelector').value;
        localStorage.setItem('current_class', currentClass);
        renderTable();
    }
    function toSec(t) { const [h, m] = t.split(':'); return h * 3600 + m * 60; }
    function adjTime(v) { timeOffset += v; localStorage.setItem('time_offset', timeOffset); }
    function toggleModal(id) { document.getElementById(id).style.display = (document.getElementById(id).style.display==='block'?'none':'block'); }
    async function toggleWake(on) { if(on) wakeLock = await navigator.wakeLock.request('screen'); else if(wakeLock) wakeLock.release(); }

    window.onload = init;
</script>
</body>
</html>
